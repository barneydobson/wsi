<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Coverage for wsimod\nodes\land.py: 87%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="coverage_html.js" defer></script>
</head>
<body class="pyfile">
<header>
    <div class="content">
        <h1>
            <span class="text">Coverage for </span><b>wsimod\nodes\land.py</b>:
            <span class="pc_cov">87%</span>
        </h1>
        <aside id="help_panel_wrapper">
            <input id="help_panel_state" type="checkbox">
            <label for="help_panel_state">
                <img id="keyboard_icon" src="keybd_closed.png" alt="Show/hide keyboard shortcuts" />
            </label>
            <div id="help_panel">
                <p class="legend">Shortcuts on this page</p>
                <div class="keyhelp">
                    <p>
                        <kbd>r</kbd>
                        <kbd>m</kbd>
                        <kbd>x</kbd>
                        &nbsp; toggle line displays
                    </p>
                    <p>
                        <kbd>j</kbd>
                        <kbd>k</kbd>
                        &nbsp; next/prev highlighted chunk
                    </p>
                    <p>
                        <kbd>0</kbd> &nbsp; (zero) top of page
                    </p>
                    <p>
                        <kbd>1</kbd> &nbsp; (one) first highlighted chunk
                    </p>
                    <p>
                        <kbd>[</kbd>
                        <kbd>]</kbd>
                        &nbsp; prev/next file
                    </p>
                    <p>
                        <kbd>u</kbd> &nbsp; up to the index
                    </p>
                    <p>
                        <kbd>?</kbd> &nbsp; show/hide this help
                    </p>
                </div>
            </div>
        </aside>
        <h2>
            <span class="text">679 statements &nbsp;</span>
            <button type="button" class="run button_toggle_run" value="run" data-shortcut="r" title="Toggle lines run">593<span class="text"> run</span></button>
            <button type="button" class="mis show_mis button_toggle_mis" value="mis" data-shortcut="m" title="Toggle lines missing">86<span class="text"> missing</span></button>
            <button type="button" class="exc show_exc button_toggle_exc" value="exc" data-shortcut="x" title="Toggle lines excluded">0<span class="text"> excluded</span></button>
        </h2>
        <p class="text">
            <a id="prevFileLink" class="nav" href="d_158041b68a4502ad_distribution_py.html">&#xab; prev</a> &nbsp; &nbsp;
            <a id="indexLink" class="nav" href="covindex.html">&Hat; index</a> &nbsp; &nbsp;
            <a id="nextFileLink" class="nav" href="d_158041b68a4502ad_nodes_py.html">&#xbb; next</a>
            &nbsp; &nbsp; &nbsp;
            <a class="nav" href="https://coverage.readthedocs.io">coverage.py v6.5.0</a>,
            created at 2022-11-05 12:05 +0000
        </p>
        <aside class="hidden">
            <button type="button" class="button_next_chunk" data-shortcut="j"/>
            <button type="button" class="button_prev_chunk" data-shortcut="k"/>
            <button type="button" class="button_top_of_page" data-shortcut="0"/>
            <button type="button" class="button_first_chunk" data-shortcut="1"/>
            <button type="button" class="button_prev_file" data-shortcut="["/>
            <button type="button" class="button_next_file" data-shortcut="]"/>
            <button type="button" class="button_to_index" data-shortcut="u"/>
            <button type="button" class="button_show_hide_help" data-shortcut="?"/>
        </aside>
    </div>
</header>
<main id="source">
    <p class="pln"><span class="n"><a id="t1" href="#t1">1</a></span><span class="t"><span class="com"># -*- coding: utf-8 -*-</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2" href="#t2">2</a></span><span class="t"><span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t3" href="#t3">3</a></span><span class="t"><span class="str">Created on Fri May 20 08:58:58 2022</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t4" href="#t4">4</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t5" href="#t5">5</a></span><span class="t"><span class="str">@author: Barney</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t6" href="#t6">6</a></span><span class="t"><span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t7" href="#t7">7</a></span><span class="t"><span class="key">from</span> <span class="nam">wsimod</span><span class="op">.</span><span class="nam">nodes</span><span class="op">.</span><span class="nam">nodes</span> <span class="key">import</span> <span class="nam">Node</span><span class="op">,</span> <span class="nam">Tank</span><span class="op">,</span> <span class="nam">DecayTank</span><span class="op">,</span> <span class="nam">QueueTank</span><span class="op">,</span> <span class="nam">ResidenceTank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t8" href="#t8">8</a></span><span class="t"><span class="key">from</span> <span class="nam">wsimod</span><span class="op">.</span><span class="nam">nodes</span><span class="op">.</span><span class="nam">nutrient_pool</span> <span class="key">import</span> <span class="nam">NutrientPool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t9" href="#t9">9</a></span><span class="t"><span class="key">from</span> <span class="nam">wsimod</span><span class="op">.</span><span class="nam">core</span> <span class="key">import</span> <span class="nam">constants</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t10" href="#t10">10</a></span><span class="t"><span class="key">from</span> <span class="nam">math</span> <span class="key">import</span> <span class="nam">exp</span><span class="op">,</span> <span class="nam">log</span><span class="op">,</span> <span class="nam">log10</span><span class="op">,</span> <span class="nam">sin</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t11" href="#t11">11</a></span><span class="t"><span class="key">from</span> <span class="nam">bisect</span> <span class="key">import</span> <span class="nam">bisect_left</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t12" href="#t12">12</a></span><span class="t"><span class="key">import</span> <span class="nam">sys</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t13" href="#t13">13</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t14" href="#t14">14</a></span><span class="t"><span class="key">class</span> <span class="nam">Land</span><span class="op">(</span><span class="nam">Node</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t15" href="#t15">15</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t16" href="#t16">16</a></span><span class="t">                        <span class="nam">name</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t17" href="#t17">17</a></span><span class="t">                        <span class="nam">subsurface_residence_time</span> <span class="op">=</span> <span class="num">5</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t18" href="#t18">18</a></span><span class="t">                        <span class="nam">percolation_residence_time</span> <span class="op">=</span> <span class="num">50</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t19" href="#t19">19</a></span><span class="t">                        <span class="nam">surface_residence_time</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t20" href="#t20">20</a></span><span class="t">                        <span class="nam">surfaces</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t21" href="#t21">21</a></span><span class="t">                        <span class="nam">data_input_dict</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t22" href="#t22">22</a></span><span class="t">        <span class="str">"""An extensive node class that represents land processes (agriculture, soil, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t23" href="#t23">23</a></span><span class="t"><span class="str">        subsurface flow, rural runoff, urban drainage, pollution deposition). The </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t24" href="#t24">24</a></span><span class="t"><span class="str">        expected use is that each distinctive type of land cover (different crop </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t25" href="#t25">25</a></span><span class="t"><span class="str">        types, gardens, forests, impervious urban drainage, etc.) each have a Surface </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t26" href="#t26">26</a></span><span class="t"><span class="str">        object, which is a subclass of Tank. The land node will iterate over its </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t27" href="#t27">27</a></span><span class="t"><span class="str">        surfaces each timestep, which will generally (except in the case of an </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t28" href="#t28">28</a></span><span class="t"><span class="str">        impervious surface) send water to three common Tanks: surface flow, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t29" href="#t29">29</a></span><span class="t"><span class="str">        subsurface flow and percolation. These tanks will then send flows to rivers </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t30" href="#t30">30</a></span><span class="t"><span class="str">        or groundwater.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t31" href="#t31">31</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t32" href="#t32">32</a></span><span class="t"><span class="str">        (See wsimod/nodes/land.py/Surface and subclasses for currently available </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t33" href="#t33">33</a></span><span class="t"><span class="str">        surfaces)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t34" href="#t34">34</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t35" href="#t35">35</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t36" href="#t36">36</a></span><span class="t"><span class="str">            name (str): node name.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t37" href="#t37">37</a></span><span class="t"><span class="str">            subsurface_residence_time (float, optional): Residence time for     </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t38" href="#t38">38</a></span><span class="t"><span class="str">                subsurface flow (see nodes.py/ResidenceTank). Defaults to 5.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t39" href="#t39">39</a></span><span class="t"><span class="str">            percolation_residence_time (int, optional): Residence time for </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t40" href="#t40">40</a></span><span class="t"><span class="str">                percolation flow (see nodes.py/ResidenceTank). Defaults to 50.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t41" href="#t41">41</a></span><span class="t"><span class="str">            surface_residence_time (int, optional): Residence time for surface flow</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t42" href="#t42">42</a></span><span class="t"><span class="str">                (see nodes.py/ResidenceTank). Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t43" href="#t43">43</a></span><span class="t"><span class="str">            surfaces (list, optional): list of dicts where each dict describes the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t44" href="#t44">44</a></span><span class="t"><span class="str">                parameters of each surface in the Land node. Each dict also contains </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t45" href="#t45">45</a></span><span class="t"><span class="str">                an entry under 'type_' which describes which subclass of surface to </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t46" href="#t46">46</a></span><span class="t"><span class="str">                use. Defaults to [].</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t47" href="#t47">47</a></span><span class="t"><span class="str">            data_input_dict (dict, optional): Dictionary of data inputs relevant for </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t48" href="#t48">48</a></span><span class="t"><span class="str">                the node (generally, et0, precipitation and temperature). Keys are </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t49" href="#t49">49</a></span><span class="t"><span class="str">                tuples where first value is the name of the variable to read from the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t50" href="#t50">50</a></span><span class="t"><span class="str">                dict and the second value is the time. Defaults to {}.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t51" href="#t51">51</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t52" href="#t52">52</a></span><span class="t"><span class="str">        Functions intended to call in orchestration:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t53" href="#t53">53</a></span><span class="t"><span class="str">            run</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t54" href="#t54">54</a></span><span class="t"><span class="str">            </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t55" href="#t55">55</a></span><span class="t"><span class="str">            apply_irrigation (if used)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t56" href="#t56">56</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t57" href="#t57">57</a></span><span class="t">        <span class="com">#Assign parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t58" href="#t58">58</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_residence_time</span> <span class="op">=</span> <span class="nam">subsurface_residence_time</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t59" href="#t59">59</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">percolation_residence_time</span> <span class="op">=</span> <span class="nam">percolation_residence_time</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t60" href="#t60">60</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">surface_residence_time</span> <span class="op">=</span> <span class="nam">surface_residence_time</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t61" href="#t61">61</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">data_input_dict</span> <span class="op">=</span> <span class="nam">data_input_dict</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t62" href="#t62">62</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t63" href="#t63">63</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="nam">name</span><span class="op">,</span> <span class="nam">data_input_dict</span> <span class="op">=</span> <span class="nam">data_input_dict</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t64" href="#t64">64</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t65" href="#t65">65</a></span><span class="t">        <span class="com">#This could be a deny but then you would have to know in advance whether a demand node has any gardening or not</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t66" href="#t66">66</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_check_handler</span><span class="op">[</span><span class="op">(</span><span class="str">'Demand'</span><span class="op">,</span><span class="str">'Garden'</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="key">lambda</span> <span class="nam">x</span> <span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t67" href="#t67">67</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_set_handler</span><span class="op">[</span><span class="op">(</span><span class="str">'Demand'</span><span class="op">,</span><span class="str">'Garden'</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="key">lambda</span> <span class="nam">x</span> <span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t68" href="#t68">68</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t69" href="#t69">69</a></span><span class="t">        <span class="com">#Create surfaces</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t70" href="#t70">70</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">irrigation_functions</span> <span class="op">=</span> <span class="op">[</span><span class="key">lambda</span> <span class="op">:</span> <span class="key">None</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t71" href="#t71">71</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t72" href="#t72">72</a></span><span class="t">        <span class="nam">surfaces_</span> <span class="op">=</span> <span class="nam">surfaces</span><span class="op">.</span><span class="nam">copy</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t73" href="#t73">73</a></span><span class="t">        <span class="nam">surfaces</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t74" href="#t74">74</a></span><span class="t">        <span class="key">for</span> <span class="nam">surface</span> <span class="key">in</span> <span class="nam">surfaces_</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t75" href="#t75">75</a></span><span class="t">            <span class="com">#Assign parent (for data reading and to determine where to send flows to)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t76" href="#t76">76</a></span><span class="t">            <span class="nam">surface</span><span class="op">[</span><span class="str">'parent'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t77" href="#t77">77</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t78" href="#t78">78</a></span><span class="t">            <span class="com">#Get surface type</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t79" href="#t79">79</a></span><span class="t">            <span class="nam">type_</span> <span class="op">=</span> <span class="nam">surface</span><span class="op">[</span><span class="str">'type_'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t80" href="#t80">80</a></span><span class="t">            <span class="key">del</span> <span class="nam">surface</span><span class="op">[</span><span class="str">'type_'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t81" href="#t81">81</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t82" href="#t82">82</a></span><span class="t">            <span class="com">#Instantiate surface and store in list of surfaces</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t83" href="#t83">83</a></span><span class="t">            <span class="nam">surfaces</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">getattr</span><span class="op">(</span><span class="nam">sys</span><span class="op">.</span><span class="nam">modules</span><span class="op">[</span><span class="nam">__name__</span><span class="op">]</span><span class="op">,</span> <span class="nam">type_</span><span class="op">)</span><span class="op">(</span><span class="op">**</span><span class="nam">surface</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t84" href="#t84">84</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t85" href="#t85">85</a></span><span class="t">            <span class="com">#Assign ds (mass balance checking)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t86" href="#t86">86</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">mass_balance_ds</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">surfaces</span><span class="op">[</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="nam">ds</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t87" href="#t87">87</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t88" href="#t88">88</a></span><span class="t">            <span class="com">#Assign any irrigation functions </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t89" href="#t89">89</a></span><span class="t">            <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">surfaces</span><span class="op">[</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">,</span> <span class="nam">IrrigationSurface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t90" href="#t90">90</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">irrigation_functions</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">surfaces</span><span class="op">[</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="nam">irrigate</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t91" href="#t91">91</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t92" href="#t92">92</a></span><span class="t">            <span class="com">#Assign garden surface functions</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t93" href="#t93">93</a></span><span class="t">            <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">surfaces</span><span class="op">[</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">,</span> <span class="nam">GardenSurface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t94" href="#t94">94</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">push_check_handler</span><span class="op">[</span><span class="op">(</span><span class="str">'Demand'</span><span class="op">,</span><span class="str">'Garden'</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="nam">surfaces</span><span class="op">[</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="nam">calculate_irrigation_demand</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t95" href="#t95">95</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">push_set_handler</span><span class="op">[</span><span class="op">(</span><span class="str">'Demand'</span><span class="op">,</span><span class="str">'Garden'</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="nam">surfaces</span><span class="op">[</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="nam">receive_irrigation_demand</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t96" href="#t96">96</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t97" href="#t97">97</a></span><span class="t">        <span class="com">#Update handlers</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t98" href="#t98">98</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_set_handler</span><span class="op">[</span><span class="str">'default'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_set_deny</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t99" href="#t99">99</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_check_handler</span><span class="op">[</span><span class="str">'default'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_check_deny</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t100" href="#t100">100</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_set_handler</span><span class="op">[</span><span class="str">'Sewer'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_set_sewer</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t101" href="#t101">101</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t102" href="#t102">102</a></span><span class="t">        <span class="com">#Create subsurface runoff, surface runoff and percolation tanks</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t103" href="#t103">103</a></span><span class="t">        <span class="com">#Can also do as timearea if this seems dodge (that is how it is done in IHACRES)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t104" href="#t104">104</a></span><span class="t">        <span class="com">#TODO should these be decayresidencetanks?</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t105" href="#t105">105</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_runoff</span> <span class="op">=</span> <span class="nam">ResidenceTank</span><span class="op">(</span><span class="nam">residence_time</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_residence_time</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t106" href="#t106">106</a></span><span class="t">                                               <span class="nam">capacity</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">UNBOUNDED_CAPACITY</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t107" href="#t107">107</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span> <span class="op">=</span> <span class="nam">ResidenceTank</span><span class="op">(</span><span class="nam">residence_time</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation_residence_time</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t108" href="#t108">108</a></span><span class="t">                                         <span class="nam">capacity</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">UNBOUNDED_CAPACITY</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t109" href="#t109">109</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">surface_runoff</span> <span class="op">=</span> <span class="nam">ResidenceTank</span><span class="op">(</span><span class="nam">residence_time</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surface_residence_time</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t110" href="#t110">110</a></span><span class="t">                                            <span class="nam">capacity</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">UNBOUNDED_CAPACITY</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t111" href="#t111">111</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t112" href="#t112">112</a></span><span class="t">        <span class="com">#Store surfaces</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t113" href="#t113">113</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">surfaces</span> <span class="op">=</span> <span class="nam">surfaces</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t114" href="#t114">114</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t115" href="#t115">115</a></span><span class="t">        <span class="com">#Mass balance checkign vqips and functions</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t116" href="#t116">116</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">running_inflow_mb</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t117" href="#t117">117</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">running_outflow_mb</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t118" href="#t118">118</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t119" href="#t119">119</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">mass_balance_in</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="key">lambda</span> <span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">running_inflow_mb</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t120" href="#t120">120</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">mass_balance_out</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="key">lambda</span> <span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">running_outflow_mb</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t121" href="#t121">121</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">mass_balance_ds</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">surface_runoff</span><span class="op">.</span><span class="nam">ds</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t122" href="#t122">122</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">mass_balance_ds</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_runoff</span><span class="op">.</span><span class="nam">ds</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t123" href="#t123">123</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">mass_balance_ds</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">.</span><span class="nam">ds</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t124" href="#t124">124</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t125" href="#t125">125</a></span><span class="t">    <span class="key">def</span> <span class="nam">apply_irrigation</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t126" href="#t126">126</a></span><span class="t">        <span class="str">"""Iterate over any irrigation functions (needs further testing.. maybe)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t127" href="#t127">127</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t128" href="#t128">128</a></span><span class="t">        <span class="key">for</span> <span class="nam">f</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">irrigation_functions</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t129" href="#t129">129</a></span><span class="t">            <span class="nam">f</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t130" href="#t130">130</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t131" href="#t131">131</a></span><span class="t">    <span class="key">def</span> <span class="nam">run</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t132" href="#t132">132</a></span><span class="t">        <span class="str">"""Call the run function in all surfaces, update surface/subsurface/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t133" href="#t133">133</a></span><span class="t"><span class="str">        percolation tanks, discharge to rivers/groundwater</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t134" href="#t134">134</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t135" href="#t135">135</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t136" href="#t136">136</a></span><span class="t">        <span class="com">#Run all surfaces</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t137" href="#t137">137</a></span><span class="t">        <span class="key">for</span> <span class="nam">surface</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surfaces</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t138" href="#t138">138</a></span><span class="t">            <span class="nam">surface</span><span class="op">.</span><span class="nam">run</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t139" href="#t139">139</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t140" href="#t140">140</a></span><span class="t">        <span class="com">#Apply residence time to percolation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t141" href="#t141">141</a></span><span class="t">        <span class="nam">percolation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">.</span><span class="nam">pull_outflow</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t142" href="#t142">142</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t143" href="#t143">143</a></span><span class="t">        <span class="com">#Distribute percolation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t144" href="#t144">144</a></span><span class="t">        <span class="nam">reply</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_distributed</span><span class="op">(</span><span class="nam">percolation</span><span class="op">,</span> <span class="nam">of_type</span> <span class="op">=</span> <span class="op">[</span><span class="str">'Groundwater'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t145" href="#t145">145</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t146" href="#t146">146</a></span><span class="t">        <span class="key">if</span> <span class="nam">reply</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">></span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t147" href="#t147">147</a></span><span class="t">            <span class="com">#Update percolation 'tank'</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t148" href="#t148">148</a></span><span class="t">            <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">reply</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t149" href="#t149">149</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t150" href="#t150">150</a></span><span class="t">        <span class="com">#Apply residence time to subsurface/surface runoff</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t151" href="#t151">151</a></span><span class="t">        <span class="nam">surface_runoff</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surface_runoff</span><span class="op">.</span><span class="nam">pull_outflow</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t152" href="#t152">152</a></span><span class="t">        <span class="nam">subsurface_runoff</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_runoff</span><span class="op">.</span><span class="nam">pull_outflow</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t153" href="#t153">153</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t154" href="#t154">154</a></span><span class="t">        <span class="com">#Total runoff</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t155" href="#t155">155</a></span><span class="t">        <span class="nam">total_runoff</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sum_vqip</span><span class="op">(</span><span class="nam">surface_runoff</span><span class="op">,</span> <span class="nam">subsurface_runoff</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t156" href="#t156">156</a></span><span class="t">        <span class="key">if</span> <span class="nam">total_runoff</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t157" href="#t157">157</a></span><span class="t">            <span class="com">#Send to rivers (or nodes, which are assumed to be junctions)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t158" href="#t158">158</a></span><span class="t">            <span class="nam">reply</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_distributed</span><span class="op">(</span><span class="nam">total_runoff</span><span class="op">,</span> <span class="nam">of_type</span> <span class="op">=</span> <span class="op">[</span><span class="str">'River'</span><span class="op">,</span><span class="str">'Node'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t159" href="#t159">159</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t160" href="#t160">160</a></span><span class="t">            <span class="com">#Redistribute total_runoff not sent</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t161" href="#t161">161</a></span><span class="t">            <span class="key">if</span> <span class="nam">reply</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t162" href="#t162">162</a></span><span class="t">                <span class="nam">reply_surface</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">reply</span><span class="op">,</span> <span class="nam">reply</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">surface_runoff</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_runoff</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t163" href="#t163">163</a></span><span class="t">                <span class="nam">reply_subsurface</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">reply</span><span class="op">,</span> <span class="nam">reply</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">subsurface_runoff</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_runoff</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t164" href="#t164">164</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t165" href="#t165">165</a></span><span class="t">                <span class="com">#Update surface/subsurface runoff 'tanks'</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t166" href="#t166">166</a></span><span class="t">                <span class="key">if</span> <span class="nam">reply_surface</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t167" href="#t167">167</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">surface_runoff</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">reply_surface</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t168" href="#t168">168</a></span><span class="t">                <span class="key">if</span> <span class="nam">reply_subsurface</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t169" href="#t169">169</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_runoff</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">reply_subsurface</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t170" href="#t170">170</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t171" href="#t171">171</a></span><span class="t">    <span class="key">def</span> <span class="nam">push_set_sewer</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t172" href="#t172">172</a></span><span class="t">        <span class="str">"""Receive water from a sewer and send it to the first ImperviousSurface in </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t173" href="#t173">173</a></span><span class="t"><span class="str">        surfaces. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t174" href="#t174">174</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t175" href="#t175">175</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t176" href="#t176">176</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount to be sent to the impervious surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t177" href="#t177">177</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t178" href="#t178">178</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t179" href="#t179">179</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of water that was not received</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t180" href="#t180">180</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t181" href="#t181">181</a></span><span class="t">        <span class="com">#TODO currently just push to the first impervious surface... not sure if people will be having multiple impervious surfaces. If people would be only having one then it would make sense to store as a parameter... this is probably fine for now</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t182" href="#t182">182</a></span><span class="t">        <span class="key">for</span> <span class="nam">surface</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surfaces</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t183" href="#t183">183</a></span><span class="t">            <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">surface</span><span class="op">,</span> <span class="nam">ImperviousSurface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t184" href="#t184">184</a></span><span class="t">                <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surface</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t185" href="#t185">185</a></span><span class="t">                <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t186" href="#t186">186</a></span><span class="t">        <span class="key">return</span> <span class="nam">vqip</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t187" href="#t187">187</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t188" href="#t188">188</a></span><span class="t">    <span class="key">def</span> <span class="nam">end_timestep</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t189" href="#t189">189</a></span><span class="t">        <span class="str">"""Update mass balance and end timestep of all tanks (and surfaces)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t190" href="#t190">190</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t191" href="#t191">191</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">running_inflow_mb</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t192" href="#t192">192</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">running_outflow_mb</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t193" href="#t193">193</a></span><span class="t">        <span class="key">for</span> <span class="nam">tanks</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surfaces</span> <span class="op">+</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">surface_runoff</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_runoff</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t194" href="#t194">194</a></span><span class="t">            <span class="nam">tanks</span><span class="op">.</span><span class="nam">end_timestep</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t195" href="#t195">195</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t196" href="#t196">196</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_surface</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">surface_</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t197" href="#t197">197</a></span><span class="t">        <span class="str">"""Return a surface from the list of surfaces by the 'surface' entry</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t198" href="#t198">198</a></span><span class="t"><span class="str">        in the surface. I.e., the name of the surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t199" href="#t199">199</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t200" href="#t200">200</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t201" href="#t201">201</a></span><span class="t"><span class="str">            surface_ (str): Name of the surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t202" href="#t202">202</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t203" href="#t203">203</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t204" href="#t204">204</a></span><span class="t"><span class="str">            surface (Surface): The first surface that matches the name</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t205" href="#t205">205</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t206" href="#t206">206</a></span><span class="t">        <span class="key">for</span> <span class="nam">surface</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surfaces</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t207" href="#t207">207</a></span><span class="t">            <span class="key">if</span> <span class="nam">surface</span><span class="op">.</span><span class="nam">surface</span> <span class="op">==</span> <span class="nam">surface_</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t208" href="#t208">208</a></span><span class="t">                <span class="key">return</span> <span class="nam">surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t209" href="#t209">209</a></span><span class="t">        <span class="key">return</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t210" href="#t210">210</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t211" href="#t211">211</a></span><span class="t">    <span class="key">def</span> <span class="nam">reinit</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t212" href="#t212">212</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">end_timestep</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t213" href="#t213">213</a></span><span class="t">        <span class="key">for</span> <span class="nam">surface</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surfaces</span> <span class="op">+</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">surface_runoff</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_runoff</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t214" href="#t214">214</a></span><span class="t">            <span class="nam">surface</span><span class="op">.</span><span class="nam">reinit</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t215" href="#t215">215</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t216" href="#t216">216</a></span><span class="t"><span class="key">class</span> <span class="nam">Surface</span><span class="op">(</span><span class="nam">DecayTank</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t217" href="#t217">217</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t218" href="#t218">218</a></span><span class="t">                        <span class="nam">surface</span> <span class="op">=</span> <span class="str">''</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t219" href="#t219">219</a></span><span class="t">                        <span class="nam">area</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t220" href="#t220">220</a></span><span class="t">                        <span class="nam">depth</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t221" href="#t221">221</a></span><span class="t">                        <span class="nam">data_input_dict</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t222" href="#t222">222</a></span><span class="t">                        <span class="nam">pollutant_load</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t223" href="#t223">223</a></span><span class="t">                        <span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t224" href="#t224">224</a></span><span class="t">        <span class="str">"""A subclass of DecayTank. Each Surface is anticipated to represent a </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t225" href="#t225">225</a></span><span class="t"><span class="str">        different land cover type of a Land node. Besides functioning as a Tank, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t226" href="#t226">226</a></span><span class="t"><span class="str">        Surfaces have three lists of functions (inflows, processes and outflows) </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t227" href="#t227">227</a></span><span class="t"><span class="str">        where behaviour can be added by appending new functions. We anticipate that </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t228" href="#t228">228</a></span><span class="t"><span class="str">        customised surfaces should be a subclass of Surface or its subclasses and add </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t229" href="#t229">229</a></span><span class="t"><span class="str">        functions to these lists. These lists are executed (inflows first, then </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t230" href="#t230">230</a></span><span class="t"><span class="str">        processes, then outflows) in the run function, which is called by the run </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t231" href="#t231">231</a></span><span class="t"><span class="str">        function in Land. The lists must return any model inflows or outflows as a </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t232" href="#t232">232</a></span><span class="t"><span class="str">        VQIP for mass balance checking.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t233" href="#t233">233</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t234" href="#t234">234</a></span><span class="t"><span class="str">        If a user wishes the DecayTank portion to be active, then can provide </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t235" href="#t235">235</a></span><span class="t"><span class="str">        'decays', which are passed upwards (see wsimod/core/core.py/DecayObj for </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t236" href="#t236">236</a></span><span class="t"><span class="str">        documentation)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t237" href="#t237">237</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t238" href="#t238">238</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t239" href="#t239">239</a></span><span class="t"><span class="str">            surface (str, optional): String description of the surface type. Doesn't </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t240" href="#t240">240</a></span><span class="t"><span class="str">                serve a modelling purpose, just used for user reference. Defaults to ''.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t241" href="#t241">241</a></span><span class="t"><span class="str">            area (float, optional): Area of surface. Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t242" href="#t242">242</a></span><span class="t"><span class="str">            depth (float, optional): Depth of tank (this has different physical </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t243" href="#t243">243</a></span><span class="t"><span class="str">                implications for different subclasses). Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t244" href="#t244">244</a></span><span class="t"><span class="str">            data_input_dict (dict, optional):  Dictionary of data inputs relevant for </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t245" href="#t245">245</a></span><span class="t"><span class="str">                the surface (generally, deposition). Keys are tuples where first </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t246" href="#t246">246</a></span><span class="t"><span class="str">                value is the name of the variable to read from the dict and the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t247" href="#t247">247</a></span><span class="t"><span class="str">                second value is the time. Note that this input should be specific to </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t248" href="#t248">248</a></span><span class="t"><span class="str">                the surface, and is not intended to be the same data input as for the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t249" href="#t249">249</a></span><span class="t"><span class="str">                land node. Also note that with each surface having its own timeseries </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t250" href="#t250">250</a></span><span class="t"><span class="str">                of data inputs, this can take up a lot of memory, thus the default </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t251" href="#t251">251</a></span><span class="t"><span class="str">                behavior is to have this as monthly data where the time variable is a </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t252" href="#t252">252</a></span><span class="t"><span class="str">                monthyear. Defaults to {}.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t253" href="#t253">253</a></span><span class="t"><span class="str">            pollutant_load (dict, optional): A dict of different pollutant amounts that </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t254" href="#t254">254</a></span><span class="t"><span class="str">                are deposited on the surface (units are mass per area per timestep). </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t255" href="#t255">255</a></span><span class="t"><span class="str">                Defaults to {}.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t256" href="#t256">256</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t257" href="#t257">257</a></span><span class="t">        <span class="com">#Assign parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t258" href="#t258">258</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">depth</span> <span class="op">=</span> <span class="nam">depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t259" href="#t259">259</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">data_input_dict</span> <span class="op">=</span> <span class="nam">data_input_dict</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t260" href="#t260">260</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">surface</span> <span class="op">=</span> <span class="nam">surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t261" href="#t261">261</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">pollutant_load</span> <span class="op">=</span> <span class="nam">pollutant_load</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t262" href="#t262">262</a></span><span class="t">        <span class="com">#TODO this is a decaytank but growing surfaces don't have decay parameters... is it a problem.. we don't even take decays as an explicit argument and insert them in kwargs..</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t263" href="#t263">263</a></span><span class="t">        <span class="nam">capacity</span> <span class="op">=</span> <span class="nam">area</span> <span class="op">*</span> <span class="nam">depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t264" href="#t264">264</a></span><span class="t">        <span class="com">#Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t265" href="#t265">265</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="nam">capacity</span> <span class="op">=</span> <span class="nam">capacity</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t266" href="#t266">266</a></span><span class="t">                                <span class="nam">area</span> <span class="op">=</span> <span class="nam">area</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t267" href="#t267">267</a></span><span class="t">                                <span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t268" href="#t268">268</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t269" href="#t269">269</a></span><span class="t">        <span class="com">#Populate function lists</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t270" href="#t270">270</a></span><span class="t">        <span class="com">#TODO.. not sure why I have deposition but no precipitation here</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t271" href="#t271">271</a></span><span class="t">        <span class="key">if</span> <span class="str">'nhx-dry'</span> <span class="key">in</span> <span class="nam">set</span><span class="op">(</span><span class="nam">x</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">for</span> <span class="nam">x</span> <span class="key">in</span> <span class="nam">data_input_dict</span><span class="op">.</span><span class="nam">keys</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t272" href="#t272">272</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span> <span class="op">=</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">atmospheric_deposition</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t273" href="#t273">273</a></span><span class="t">                            <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation_deposition</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t274" href="#t274">274</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t275" href="#t275">275</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t276" href="#t276">276</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">pollutant_load</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t277" href="#t277">277</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">simple_deposition</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t278" href="#t278">278</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t279" href="#t279">279</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">outflows</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t280" href="#t280">280</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t281" href="#t281">281</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t282" href="#t282">282</a></span><span class="t">    <span class="key">def</span> <span class="nam">run</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t283" href="#t283">283</a></span><span class="t">        <span class="str">"""Call run function (called from Land node)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t284" href="#t284">284</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t285" href="#t285">285</a></span><span class="t">        <span class="key">if</span> <span class="str">'nitrite'</span> <span class="key">in</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">POLLUTANTS</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t286" href="#t286">286</a></span><span class="t">            <span class="com">#Assume that if nitrite is modelled then nitrification is also modelled</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t287" href="#t287">287</a></span><span class="t">            <span class="com">#You will need ammonia->nitrite->nitrate decay to accurate simulate ammonia</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t288" href="#t288">288</a></span><span class="t">            <span class="com">#Thus, these decays are simulated here</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t289" href="#t289">289</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t290" href="#t290">290</a></span><span class="t">            <span class="com">#NOTE decay in a decaytank happens at start of timestep (confusingly) in the end_timestep function</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t291" href="#t291">291</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_decayed</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t292" href="#t292">292</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">running_inflow_mb</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_decayed</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t293" href="#t293">293</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t294" href="#t294">294</a></span><span class="t">            <span class="com">#Decayed ammonia becomes nitrite</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t295" href="#t295">295</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_decayed</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t296" href="#t296">296</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">running_inflow_mb</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_decayed</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t297" href="#t297">297</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t298" href="#t298">298</a></span><span class="t">        <span class="key">for</span> <span class="nam">f</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">outflows</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t299" href="#t299">299</a></span><span class="t">            <span class="com">#Iterate over function lists, updating mass balance</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t300" href="#t300">300</a></span><span class="t">            <span class="nam">in_</span><span class="op">,</span> <span class="nam">out_</span> <span class="op">=</span> <span class="nam">f</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t301" href="#t301">301</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">running_inflow_mb</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sum_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">running_inflow_mb</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t302" href="#t302">302</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">running_outflow_mb</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sum_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">running_outflow_mb</span><span class="op">,</span> <span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t303" href="#t303">303</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t304" href="#t304">304</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_data_input</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">var</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t305" href="#t305">305</a></span><span class="t">        <span class="str">"""Read data input from parent Land node (i.e., for precipitation/et0/temp)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t306" href="#t306">306</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t307" href="#t307">307</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t308" href="#t308">308</a></span><span class="t"><span class="str">            var (str): Name of variable</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t309" href="#t309">309</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t310" href="#t310">310</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t311" href="#t311">311</a></span><span class="t"><span class="str">            Data read</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t312" href="#t312">312</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t313" href="#t313">313</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="nam">var</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t314" href="#t314">314</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t315" href="#t315">315</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_data_input_surface</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">var</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t316" href="#t316">316</a></span><span class="t">        <span class="str">"""Read data input from this surface's data_input_dict</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t317" href="#t317">317</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t318" href="#t318">318</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t319" href="#t319">319</a></span><span class="t"><span class="str">            var (str): Name of variable</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t320" href="#t320">320</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t321" href="#t321">321</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t322" href="#t322">322</a></span><span class="t"><span class="str">            Data read</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t323" href="#t323">323</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t324" href="#t324">324</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">data_input_dict</span><span class="op">[</span><span class="op">(</span><span class="nam">var</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">monthyear</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t325" href="#t325">325</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t326" href="#t326">326</a></span><span class="t">    <span class="key">def</span> <span class="nam">dry_deposition_to_tank</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t327" href="#t327">327</a></span><span class="t">        <span class="str">"""Generic function for allocating dry pollution deposition to the surface.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t328" href="#t328">328</a></span><span class="t"><span class="str">        Simply sends the pollution into the tank (some subclasses overwrite this </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t329" href="#t329">329</a></span><span class="t"><span class="str">        behaviour)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t330" href="#t330">330</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t331" href="#t331">331</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t332" href="#t332">332</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of dry deposition to send to tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t333" href="#t333">333</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t334" href="#t334">334</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t335" href="#t335">335</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of dry deposition that entered the tank (used </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t336" href="#t336">336</a></span><span class="t"><span class="str">                for mass balance checking)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t337" href="#t337">337</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t338" href="#t338">338</a></span><span class="t">        <span class="com">#Default behaviour is to just enter the tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t339" href="#t339">339</a></span><span class="t">        <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t340" href="#t340">340</a></span><span class="t">        <span class="key">return</span> <span class="nam">vqip</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t341" href="#t341">341</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t342" href="#t342">342</a></span><span class="t">    <span class="key">def</span> <span class="nam">wet_deposition_to_tank</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t343" href="#t343">343</a></span><span class="t">        <span class="str">"""Generic function for allocating wet pollution deposition to the surface.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t344" href="#t344">344</a></span><span class="t"><span class="str">        Simply sends the pollution into the tank (some subclasses overwrite this </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t345" href="#t345">345</a></span><span class="t"><span class="str">        behaviour)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t346" href="#t346">346</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t347" href="#t347">347</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t348" href="#t348">348</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of wet deposition to send to tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t349" href="#t349">349</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t350" href="#t350">350</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t351" href="#t351">351</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of wet deposition that entered the tank (used </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t352" href="#t352">352</a></span><span class="t"><span class="str">                for mass balance checking)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t353" href="#t353">353</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t354" href="#t354">354</a></span><span class="t">        <span class="com">#Default behaviour is to just enter the tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t355" href="#t355">355</a></span><span class="t">        <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t356" href="#t356">356</a></span><span class="t">        <span class="key">return</span> <span class="nam">vqip</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t357" href="#t357">357</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t358" href="#t358">358</a></span><span class="t">    <span class="key">def</span> <span class="nam">simple_deposition</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t359" href="#t359">359</a></span><span class="t">        <span class="str">"""Inflow function to cause simple pollution deposition to occur, updating the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t360" href="#t360">360</a></span><span class="t"><span class="str">        surface tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t361" href="#t361">361</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t362" href="#t362">362</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t363" href="#t363">363</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t364" href="#t364">364</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t365" href="#t365">365</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t366" href="#t366">366</a></span><span class="t">        <span class="nam">pollution</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t367" href="#t367">367</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t368" href="#t368">368</a></span><span class="t">        <span class="com">#Scale by area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t369" href="#t369">369</a></span><span class="t">        <span class="key">for</span> <span class="nam">pol</span><span class="op">,</span> <span class="nam">item</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pollutant_load</span><span class="op">.</span><span class="nam">items</span><span class="op">(</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t370" href="#t370">370</a></span><span class="t">            <span class="nam">pollution</span><span class="op">[</span><span class="nam">pol</span><span class="op">]</span> <span class="op">=</span> <span class="nam">item</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t371" href="#t371">371</a></span><span class="t">        <span class="nam">pollution</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t372" href="#t372">372</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t373" href="#t373">373</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t374" href="#t374">374</a></span><span class="t">        <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">pollution</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t375" href="#t375">375</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t376" href="#t376">376</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">pollution</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t377" href="#t377">377</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t378" href="#t378">378</a></span><span class="t">    <span class="key">def</span> <span class="nam">atmospheric_deposition</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t379" href="#t379">379</a></span><span class="t">        <span class="str">"""Inflow function to cause dry atmospheric deposition to occur, updating the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t380" href="#t380">380</a></span><span class="t"><span class="str">        surface tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t381" href="#t381">381</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t382" href="#t382">382</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t383" href="#t383">383</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t384" href="#t384">384</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t385" href="#t385">385</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t386" href="#t386">386</a></span><span class="t">        <span class="com">#TODO double check units in preprocessing - is weight of N or weight of NHX/noy?</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t387" href="#t387">387</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t388" href="#t388">388</a></span><span class="t">        <span class="com">#Read data and scale</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t389" href="#t389">389</a></span><span class="t">        <span class="nam">nhx</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'nhx-dry'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t390" href="#t390">390</a></span><span class="t">        <span class="nam">noy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'noy-dry'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t391" href="#t391">391</a></span><span class="t">        <span class="nam">srp</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'srp-dry'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t392" href="#t392">392</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t393" href="#t393">393</a></span><span class="t">        <span class="com">#Assign pollutants</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t394" href="#t394">394</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t395" href="#t395">395</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nhx</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t396" href="#t396">396</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">noy</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t397" href="#t397">397</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">srp</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t398" href="#t398">398</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t399" href="#t399">399</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t400" href="#t400">400</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">dry_deposition_to_tank</span><span class="op">(</span><span class="nam">vqip</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t401" href="#t401">401</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t402" href="#t402">402</a></span><span class="t">        <span class="com">#Return mass balance</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t403" href="#t403">403</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t404" href="#t404">404</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t405" href="#t405">405</a></span><span class="t">    <span class="key">def</span> <span class="nam">precipitation_deposition</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t406" href="#t406">406</a></span><span class="t">        <span class="str">"""Inflow function to cause wet precipitation deposition to occur, updating </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t407" href="#t407">407</a></span><span class="t"><span class="str">        the surface tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t408" href="#t408">408</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t409" href="#t409">409</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t410" href="#t410">410</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t411" href="#t411">411</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t412" href="#t412">412</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t413" href="#t413">413</a></span><span class="t">        <span class="com">#TODO double check units - is weight of N or weight of NHX/noy?</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t414" href="#t414">414</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t415" href="#t415">415</a></span><span class="t">        <span class="com">#Read data and scale</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t416" href="#t416">416</a></span><span class="t">        <span class="nam">nhx</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'nhx-wet'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t417" href="#t417">417</a></span><span class="t">        <span class="nam">noy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'noy-wet'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t418" href="#t418">418</a></span><span class="t">        <span class="nam">srp</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'srp-wet'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t419" href="#t419">419</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t420" href="#t420">420</a></span><span class="t">        <span class="com">#Assign pollutants</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t421" href="#t421">421</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t422" href="#t422">422</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nhx</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t423" href="#t423">423</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">noy</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t424" href="#t424">424</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">srp</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t425" href="#t425">425</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t426" href="#t426">426</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t427" href="#t427">427</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">wet_deposition_to_tank</span><span class="op">(</span><span class="nam">vqip</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t428" href="#t428">428</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t429" href="#t429">429</a></span><span class="t">        <span class="com">#Return mass balance</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t430" href="#t430">430</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t431" href="#t431">431</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t432" href="#t432">432</a></span><span class="t"><span class="key">class</span> <span class="nam">ImperviousSurface</span><span class="op">(</span><span class="nam">Surface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t433" href="#t433">433</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t434" href="#t434">434</a></span><span class="t">                        <span class="nam">pore_depth</span> <span class="op">=</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t435" href="#t435">435</a></span><span class="t">                        <span class="nam">et0_to_e</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t436" href="#t436">436</a></span><span class="t">                        <span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t437" href="#t437">437</a></span><span class="t">        <span class="str">"""A surface to represent impervious surfaces that drain to storm sewers. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t438" href="#t438">438</a></span><span class="t"><span class="str">        Runoff is generated by the surface tank overflowing, if a user wants all </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t439" href="#t439">439</a></span><span class="t"><span class="str">        precipitation to immediately go to runoff then they should reduce 'pore_depth', </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t440" href="#t440">440</a></span><span class="t"><span class="str">        however generally this is not what happens and a small (a few mm) depth should </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t441" href="#t441">441</a></span><span class="t"><span class="str">        be assigned to the tank. Also includes urban pollution deposition, though this </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t442" href="#t442">442</a></span><span class="t"><span class="str">        will only be mobilised if runoff occurs. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t443" href="#t443">443</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t444" href="#t444">444</a></span><span class="t"><span class="str">        Note that the tank does not have a runoff coefficient because it doesn't make </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t445" href="#t445">445</a></span><span class="t"><span class="str">        sense from an integrated perspective. If a user wants to mimic runoff </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t446" href="#t446">446</a></span><span class="t"><span class="str">        coefficient-like behaviour, then they should reduce the ImperviousSurface tank </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t447" href="#t447">447</a></span><span class="t"><span class="str">        size, and increase other surfaces of the parent land node accordingly.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t448" href="#t448">448</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t449" href="#t449">449</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t450" href="#t450">450</a></span><span class="t"><span class="str">            pore_depth (float, optional): The depth of the tank that must be exceeded </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t451" href="#t451">451</a></span><span class="t"><span class="str">                to generate runoff. Intended to represent the pores in ashpalt that </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t452" href="#t452">452</a></span><span class="t"><span class="str">                water accumulates in before flowing. Defaults to 0.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t453" href="#t453">453</a></span><span class="t"><span class="str">            et0_to_e (float, optional): Multiplier applied to the parent's data </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t454" href="#t454">454</a></span><span class="t"><span class="str">                timeseries of et0 to determine how much evaporation takes place on the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t455" href="#t455">455</a></span><span class="t"><span class="str">                ImperviousSurface. Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t456" href="#t456">456</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t457" href="#t457">457</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t458" href="#t458">458</a></span><span class="t">        <span class="com">#Assign parameters </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t459" href="#t459">459</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">et0_to_e</span> <span class="op">=</span> <span class="nam">et0_to_e</span> <span class="com">#Total evaporation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t460" href="#t460">460</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t461" href="#t461">461</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t462" href="#t462">462</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="nam">depth</span> <span class="op">=</span> <span class="nam">pore_depth</span><span class="op">,</span><span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t463" href="#t463">463</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t464" href="#t464">464</a></span><span class="t">        <span class="com">#Initialise state variables</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t465" href="#t465">465</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t466" href="#t466">466</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t467" href="#t467">467</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t468" href="#t468">468</a></span><span class="t">        <span class="com">#Populate function lists</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t469" href="#t469">469</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">precipitation_evaporation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t470" href="#t470">470</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t471" href="#t471">471</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">outflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">push_to_sewers</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t472" href="#t472">472</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t473" href="#t473">473</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t474" href="#t474">474</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t475" href="#t475">475</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t476" href="#t476">476</a></span><span class="t">    <span class="key">def</span> <span class="nam">precipitation_evaporation</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t477" href="#t477">477</a></span><span class="t">        <span class="str">"""Inflow function that is a simple rainfall-evaporation model, updating the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t478" href="#t478">478</a></span><span class="t"><span class="str">        surface tank. All precipitation that is not evaporated is forced into the tank </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t479" href="#t479">479</a></span><span class="t"><span class="str">        (even though some of that will later be pushed to sewers) - this enables runoff </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t480" href="#t480">480</a></span><span class="t"><span class="str">        to mix with the accumulated pollutants in the surface pores.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t481" href="#t481">481</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t482" href="#t482">482</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t483" href="#t483">483</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t484" href="#t484">484</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t485" href="#t485">485</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t486" href="#t486">486</a></span><span class="t">        <span class="com">#Read data in length units</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t487" href="#t487">487</a></span><span class="t">        <span class="nam">precipitation_depth</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'precipitation'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t488" href="#t488">488</a></span><span class="t">        <span class="nam">evaporation_depth</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'et0'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">et0_to_e</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t489" href="#t489">489</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t490" href="#t490">490</a></span><span class="t">        <span class="key">if</span> <span class="nam">precipitation_depth</span> <span class="op">&lt;</span> <span class="nam">evaporation_depth</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t491" href="#t491">491</a></span><span class="t">            <span class="com">#No effective precipitation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t492" href="#t492">492</a></span><span class="t">            <span class="nam">net_precipitation</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t493" href="#t493">493</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t494" href="#t494">494</a></span><span class="t">            <span class="com">#Calculate how much should be evaporated from pores</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t495" href="#t495">495</a></span><span class="t">            <span class="nam">evaporation_from_pores</span> <span class="op">=</span> <span class="nam">evaporation_depth</span> <span class="op">-</span> <span class="nam">precipitation_depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t496" href="#t496">496</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t497" href="#t497">497</a></span><span class="t">            <span class="com">#Scale</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t498" href="#t498">498</a></span><span class="t">            <span class="nam">evaporation_from_pores</span> <span class="op">*=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t499" href="#t499">499</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t500" href="#t500">500</a></span><span class="t">            <span class="com">#Pull from tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t501" href="#t501">501</a></span><span class="t">            <span class="nam">evaporation_from_pores</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">evaporate</span><span class="op">(</span><span class="nam">evaporation_from_pores</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t502" href="#t502">502</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t503" href="#t503">503</a></span><span class="t">            <span class="com">#Scale to get actual evaporation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t504" href="#t504">504</a></span><span class="t">            <span class="nam">total_evaporation</span> <span class="op">=</span> <span class="nam">evaporation_from_pores</span> <span class="op">+</span> <span class="nam">precipitation_depth</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t505" href="#t505">505</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t506" href="#t506">506</a></span><span class="t">            <span class="com">#Effective precipitation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t507" href="#t507">507</a></span><span class="t">            <span class="nam">net_precipitation</span> <span class="op">=</span> <span class="nam">precipitation_depth</span> <span class="op">-</span> <span class="nam">evaporation_depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t508" href="#t508">508</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t509" href="#t509">509</a></span><span class="t">            <span class="com">#Scale</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t510" href="#t510">510</a></span><span class="t">            <span class="nam">net_precipitation</span> <span class="op">*=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t511" href="#t511">511</a></span><span class="t">            <span class="nam">net_precipitation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">net_precipitation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t512" href="#t512">512</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t513" href="#t513">513</a></span><span class="t">            <span class="com">#Assign a temperature value</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t514" href="#t514">514</a></span><span class="t">            <span class="com">#TODO how hot is rain? No idea... just going to use surface air temperature</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t515" href="#t515">515</a></span><span class="t">            <span class="nam">net_precipitation</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'temperature'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t516" href="#t516">516</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t517" href="#t517">517</a></span><span class="t">            <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t518" href="#t518">518</a></span><span class="t">            <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">net_precipitation</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t519" href="#t519">519</a></span><span class="t">            <span class="nam">total_evaporation</span> <span class="op">=</span> <span class="nam">evaporation_depth</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t520" href="#t520">520</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t521" href="#t521">521</a></span><span class="t">        <span class="com">#Converrt to VQIP</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t522" href="#t522">522</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">total_evaporation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t523" href="#t523">523</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">precipitation_depth</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t524" href="#t524">524</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t525" href="#t525">525</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t526" href="#t526">526</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t527" href="#t527">527</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t528" href="#t528">528</a></span><span class="t">    <span class="key">def</span> <span class="nam">push_to_sewers</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t529" href="#t529">529</a></span><span class="t">        <span class="str">"""Outflow function that distributes ponded water (i.e., surface runoff) to the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t530" href="#t530">530</a></span><span class="t"><span class="str">        parent node's attached sewers</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t531" href="#t531">531</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t532" href="#t532">532</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t533" href="#t533">533</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t534" href="#t534">534</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t535" href="#t535">535</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t536" href="#t536">536</a></span><span class="t">        <span class="com">#Get runoff</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t537" href="#t537">537</a></span><span class="t">        <span class="nam">surface_runoff</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_ponded</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t538" href="#t538">538</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t539" href="#t539">539</a></span><span class="t">        <span class="com">#Distribute</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t540" href="#t540">540</a></span><span class="t">        <span class="com">#TODO in cwsd_partition this is done with timearea</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t541" href="#t541">541</a></span><span class="t">        <span class="nam">reply</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">push_distributed</span><span class="op">(</span><span class="nam">surface_runoff</span><span class="op">,</span> <span class="nam">of_type</span> <span class="op">=</span> <span class="op">[</span><span class="str">'Sewer'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t542" href="#t542">542</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t543" href="#t543">543</a></span><span class="t">        <span class="com">#Update tank (forcing, because if the water can't go to the sewer, where else can it go)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t544" href="#t544">544</a></span><span class="t">        <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">reply</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t545" href="#t545">545</a></span><span class="t">        <span class="com">#TODO... possibly this could flow to attached river or land nodes.. or other surfaces? I expect this doesn't matter for large scale models.. but may need to be revisited for detailed sewer models</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t546" href="#t546">546</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t547" href="#t547">547</a></span><span class="t">        <span class="com">#Return empty mass balance because outflows are handled by parent</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t548" href="#t548">548</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t549" href="#t549">549</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t550" href="#t550">550</a></span><span class="t"><span class="key">class</span> <span class="nam">PerviousSurface</span><span class="op">(</span><span class="nam">Surface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t551" href="#t551">551</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t552" href="#t552">552</a></span><span class="t">                        <span class="nam">depth</span> <span class="op">=</span> <span class="num">0.75</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t553" href="#t553">553</a></span><span class="t">                        <span class="nam">field_capacity</span> <span class="op">=</span> <span class="num">0.3</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t554" href="#t554">554</a></span><span class="t">                        <span class="nam">wilting_point</span> <span class="op">=</span> <span class="num">0.12</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t555" href="#t555">555</a></span><span class="t">                        <span class="nam">infiltration_capacity</span> <span class="op">=</span> <span class="num">0.5</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t556" href="#t556">556</a></span><span class="t">                        <span class="nam">surface_coefficient</span> <span class="op">=</span> <span class="num">0.05</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t557" href="#t557">557</a></span><span class="t">                        <span class="nam">percolation_coefficient</span> <span class="op">=</span> <span class="num">0.75</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t558" href="#t558">558</a></span><span class="t">                        <span class="nam">et0_coefficient</span> <span class="op">=</span> <span class="num">0.5</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t559" href="#t559">559</a></span><span class="t">                        <span class="nam">ihacres_p</span> <span class="op">=</span> <span class="num">10</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t560" href="#t560">560</a></span><span class="t">                        <span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t561" href="#t561">561</a></span><span class="t">        <span class="str">"""A generic pervious surface that represents hydrology with the IHACRES model.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t562" href="#t562">562</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t563" href="#t563">563</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t564" href="#t564">564</a></span><span class="t"><span class="str">            depth (float, optional): Soil tank (i.e., root) depth. Defaults to 0.75.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t565" href="#t565">565</a></span><span class="t"><span class="str">            field_capacity (float, optional): The field capacity IHACRES parameter</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t566" href="#t566">566</a></span><span class="t"><span class="str">                (i.e., when water content in the soil tank is above this value - flows </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t567" href="#t567">567</a></span><span class="t"><span class="str">                of any kind can be generated). Defaults to 0.3.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t568" href="#t568">568</a></span><span class="t"><span class="str">            wilting_point (float, optional): The wilting point IHACRES parameter (i.e., </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t569" href="#t569">569</a></span><span class="t"><span class="str">                when water content content in the soil tank is above this value - </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t570" href="#t570">570</a></span><span class="t"><span class="str">                plants can uptake water and evaporation from the soil tank can occur). </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t571" href="#t571">571</a></span><span class="t"><span class="str">                Defaults to 0.12.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t572" href="#t572">572</a></span><span class="t"><span class="str">            infiltration_capacity (float, optional): Depth of water per day that can </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t573" href="#t573">573</a></span><span class="t"><span class="str">                enter the soil tank. Non infiltrated water will pond and travel as </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t574" href="#t574">574</a></span><span class="t"><span class="str">                surface runoff from the parent Land node. Defaults to 0.5.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t575" href="#t575">575</a></span><span class="t"><span class="str">            surface_coefficient (float, optional): If flow is generated, the proportion </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t576" href="#t576">576</a></span><span class="t"><span class="str">                of flow that goes to surface runoff. Defaults to 0.05.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t577" href="#t577">577</a></span><span class="t"><span class="str">            percolation_coefficient (float, optional): If flow is generated, then the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t578" href="#t578">578</a></span><span class="t"><span class="str">                proportion of water that does not go to surface runoff that goes to </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t579" href="#t579">579</a></span><span class="t"><span class="str">                percolation (i.e., groundwater) - the remainder goes to subsurface </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t580" href="#t580">580</a></span><span class="t"><span class="str">                runoff. Defaults to 0.75.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t581" href="#t581">581</a></span><span class="t"><span class="str">            et0_coefficient (float, optional): Convert between the parent nodes data </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t582" href="#t582">582</a></span><span class="t"><span class="str">                timeseries et0 - and potential evaptranspiration per unit area for this </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t583" href="#t583">583</a></span><span class="t"><span class="str">                surface. Defaults to=0.5,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t584" href="#t584">584</a></span><span class="t"><span class="str">            ihacres_p (float, optional): The IHACRES p parameter. Unless it is an </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t585" href="#t585">585</a></span><span class="t"><span class="str">                ephemeral stream this parameter probably can stay high. Defaults to 10.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t586" href="#t586">586</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t587" href="#t587">587</a></span><span class="t">       <span class="com">#Assign parameters (converting field capacity and wilting point to depth)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t588" href="#t588">588</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span> <span class="op">=</span> <span class="nam">field_capacity</span> <span class="op">*</span> <span class="nam">depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t589" href="#t589">589</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">wilting_point</span> <span class="op">=</span> <span class="nam">wilting_point</span> <span class="op">*</span> <span class="nam">depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t590" href="#t590">590</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_capacity</span> <span class="op">=</span> <span class="nam">infiltration_capacity</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t591" href="#t591">591</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">surface_coefficient</span> <span class="op">=</span> <span class="nam">surface_coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t592" href="#t592">592</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">percolation_coefficient</span> <span class="op">=</span> <span class="nam">percolation_coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t593" href="#t593">593</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">et0_coefficient</span> <span class="op">=</span> <span class="nam">et0_coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t594" href="#t594">594</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ihacres_p</span> <span class="op">=</span> <span class="nam">ihacres_p</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t595" href="#t595">595</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t596" href="#t596">596</a></span><span class="t">        <span class="com">#Parameters to determine how to calculate the temperature of outflowing water</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t597" href="#t597">597</a></span><span class="t">        <span class="com">#TODO what should these params be?</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t598" href="#t598">598</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_prev</span> <span class="op">=</span> <span class="num">0.1</span> <span class="com">#previous timestep weighting</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t599" href="#t599">599</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_air</span> <span class="op">=</span> <span class="num">0.6</span> <span class="com">#air temperature weighting</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t600" href="#t600">600</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_deep</span> <span class="op">=</span> <span class="num">0.1</span> <span class="com">#deep soil temperature weighting</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t601" href="#t601">601</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_deep</span> <span class="op">=</span> <span class="num">10</span> <span class="com">#deep soil temperature</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t602" href="#t602">602</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t603" href="#t603">603</a></span><span class="t">        <span class="com">#IHACRES is a deficit not a tank, so doesn't really have a capacity in this way... and if it did.. I don't know if it would be the root depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t604" href="#t604">604</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="nam">depth</span><span class="op">=</span><span class="nam">depth</span><span class="op">,</span><span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t605" href="#t605">605</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t606" href="#t606">606</a></span><span class="t">        <span class="com">#Calculate subsurface coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t607" href="#t607">607</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_coefficient</span> <span class="op">=</span> <span class="num">1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation_coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t608" href="#t608">608</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t609" href="#t609">609</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t610" href="#t610">610</a></span><span class="t">        <span class="com">#Initiliase state variables</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t611" href="#t611">611</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t612" href="#t612">612</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t613" href="#t613">613</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t614" href="#t614">614</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">tank_recharge</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t615" href="#t615">615</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t616" href="#t616">616</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t617" href="#t617">617</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t618" href="#t618">618</a></span><span class="t">        <span class="com">#Populate function lists</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t619" href="#t619">619</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ihacres</span><span class="op">)</span> <span class="com">#work out runoff</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t620" href="#t620">620</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t621" href="#t621">621</a></span><span class="t">        <span class="com">#TODO interception if I hate myself enough?</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t622" href="#t622">622</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">calculate_soil_temperature</span><span class="op">)</span> <span class="com"># Calculate soil temp + dependence factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t623" href="#t623">623</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t624" href="#t624">624</a></span><span class="t">        <span class="com"># self.processes.append(self.decay) #apply generic decay (currently handled by decaytank at end of timestep)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t625" href="#t625">625</a></span><span class="t">        <span class="com">#TODO decaytank uses air temperature not soil temperature... probably need to just give it the decay function</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t626" href="#t626">626</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t627" href="#t627">627</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">outflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">route</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t628" href="#t628">628</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t629" href="#t629">629</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_cmd</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t630" href="#t630">630</a></span><span class="t">        <span class="str">"""Calculate moisture deficit (i.e., the tank excess converted to depth)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t631" href="#t631">631</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t632" href="#t632">632</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t633" href="#t633">633</a></span><span class="t"><span class="str">            (float): current moisture deficit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t634" href="#t634">634</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t635" href="#t635">635</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_excess</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t636" href="#t636">636</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t637" href="#t637">637</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_smc</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t638" href="#t638">638</a></span><span class="t">        <span class="str">"""Calculate moisture content (i.e., the tank volume converted to depth)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t639" href="#t639">639</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t640" href="#t640">640</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t641" href="#t641">641</a></span><span class="t"><span class="str">            (float): soil moisture content</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t642" href="#t642">642</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t643" href="#t643">643</a></span><span class="t">        <span class="com">#Depth of soil moisture</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t644" href="#t644">644</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t645" href="#t645">645</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t646" href="#t646">646</a></span><span class="t">    <span class="key">def</span> <span class="nam">ihacres</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t647" href="#t647">647</a></span><span class="t">        <span class="str">"""Inflow function that runs the IHACRES model equations, updates tanks, and </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t648" href="#t648">648</a></span><span class="t"><span class="str">        store flows in state variables (which are later sent to the parent land node in </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t649" href="#t649">649</a></span><span class="t"><span class="str">        the route function)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t650" href="#t650">650</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t651" href="#t651">651</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t652" href="#t652">652</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t653" href="#t653">653</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t654" href="#t654">654</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t655" href="#t655">655</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t656" href="#t656">656</a></span><span class="t">        <span class="com">#Read data (leave in depth units since that is what IHACRES equations are in)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t657" href="#t657">657</a></span><span class="t">        <span class="nam">precipitation_depth</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'precipitation'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t658" href="#t658">658</a></span><span class="t">        <span class="nam">evaporation_depth</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'et0'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">et0_coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t659" href="#t659">659</a></span><span class="t">        <span class="nam">temperature</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'temperature'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t660" href="#t660">660</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t661" href="#t661">661</a></span><span class="t">        <span class="com">#Apply infiltration</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t662" href="#t662">662</a></span><span class="t">        <span class="nam">infiltrated_precipitation</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="nam">precipitation_depth</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_capacity</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t663" href="#t663">663</a></span><span class="t">        <span class="nam">infiltration_excess</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">precipitation_depth</span> <span class="op">-</span> <span class="nam">infiltrated_precipitation</span><span class="op">,</span> <span class="num">0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t664" href="#t664">664</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t665" href="#t665">665</a></span><span class="t">        <span class="com">#Get current moisture deficit</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t666" href="#t666">666</a></span><span class="t">        <span class="nam">current_moisture_deficit_depth</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_cmd</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t667" href="#t667">667</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t668" href="#t668">668</a></span><span class="t">        <span class="com">#IHACRES equations (we do (depth - wilting_point or field capacity) to convert from a deficit to storage tank)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t669" href="#t669">669</a></span><span class="t">        <span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">evaporation_depth</span> <span class="op">*</span> <span class="nam">min</span><span class="op">(</span><span class="num">1</span><span class="op">,</span> <span class="nam">exp</span><span class="op">(</span><span class="num">2</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">current_moisture_deficit_depth</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">depth</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">wilting_point</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t670" href="#t670">670</a></span><span class="t">        <span class="nam">outflow</span> <span class="op">=</span> <span class="nam">infiltrated_precipitation</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">min</span><span class="op">(</span><span class="num">1</span><span class="op">,</span> <span class="op">(</span><span class="nam">current_moisture_deficit_depth</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">depth</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span><span class="op">)</span><span class="op">)</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ihacres_p</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t671" href="#t671">671</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t672" href="#t672">672</a></span><span class="t">        <span class="com">#Can't evaporate more than available moisture (presumably the IHACRES equation prevents this ever being needed)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t673" href="#t673">673</a></span><span class="t">        <span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="nam">evaporation</span><span class="op">,</span> <span class="nam">precipitation_depth</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_smc</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t674" href="#t674">674</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t675" href="#t675">675</a></span><span class="t">        <span class="com">#Scale to volumes and apply proportions to work out percolation/surface runoff/subsurface runoff</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t676" href="#t676">676</a></span><span class="t">        <span class="nam">surface</span> <span class="op">=</span> <span class="nam">outflow</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">surface_coefficient</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t677" href="#t677">677</a></span><span class="t">        <span class="nam">percolation</span> <span class="op">=</span> <span class="nam">outflow</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span><span class="op">-</span><span class="nam">self</span><span class="op">.</span><span class="nam">surface_coefficient</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation_coefficient</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t678" href="#t678">678</a></span><span class="t">        <span class="nam">subsurface_flow</span> <span class="op">=</span> <span class="nam">outflow</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span><span class="op">-</span><span class="nam">self</span><span class="op">.</span><span class="nam">surface_coefficient</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_coefficient</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t679" href="#t679">679</a></span><span class="t">        <span class="nam">tank_recharge</span> <span class="op">=</span> <span class="op">(</span><span class="nam">infiltrated_precipitation</span> <span class="op">-</span> <span class="nam">evaporation</span> <span class="op">-</span> <span class="nam">outflow</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t680" href="#t680">680</a></span><span class="t">        <span class="nam">infiltration_excess</span> <span class="op">*=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t681" href="#t681">681</a></span><span class="t">        <span class="nam">infiltration_excess</span> <span class="op">+=</span> <span class="nam">surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t682" href="#t682">682</a></span><span class="t">        <span class="nam">evaporation</span> <span class="op">*=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t683" href="#t683">683</a></span><span class="t">        <span class="nam">precipitation</span> <span class="op">=</span> <span class="nam">precipitation_depth</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t684" href="#t684">684</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t685" href="#t685">685</a></span><span class="t">        <span class="com">#Mix in tank to calculate pollutant concentrations</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t686" href="#t686">686</a></span><span class="t">        <span class="nam">total_water_passing_through_soil_tank</span> <span class="op">=</span> <span class="nam">tank_recharge</span> <span class="op">+</span> <span class="nam">subsurface_flow</span> <span class="op">+</span> <span class="nam">percolation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t687" href="#t687">687</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t688" href="#t688">688</a></span><span class="t">        <span class="key">if</span> <span class="nam">total_water_passing_through_soil_tank</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t689" href="#t689">689</a></span><span class="t">            <span class="com">#Net effective preipitation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t690" href="#t690">690</a></span><span class="t">            <span class="nam">total_water_passing_through_soil_tank</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">total_water_passing_through_soil_tank</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t691" href="#t691">691</a></span><span class="t">            <span class="com">#Assign a temperature before sending into tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t692" href="#t692">692</a></span><span class="t">            <span class="nam">total_water_passing_through_soil_tank</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">temperature</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t693" href="#t693">693</a></span><span class="t">            <span class="com">#Assign to tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t694" href="#t694">694</a></span><span class="t">            <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">total_water_passing_through_soil_tank</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t695" href="#t695">695</a></span><span class="t">            <span class="com">#Pull flows (which now have nonzero pollutant concentrations)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t696" href="#t696">696</a></span><span class="t">            <span class="nam">subsurface_flow</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_storage</span><span class="op">(</span><span class="op">{</span><span class="str">'volume'</span><span class="op">:</span> <span class="nam">subsurface_flow</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t697" href="#t697">697</a></span><span class="t">            <span class="nam">percolation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_storage</span><span class="op">(</span><span class="op">{</span><span class="str">'volume'</span><span class="op">:</span><span class="nam">percolation</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t698" href="#t698">698</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t699" href="#t699">699</a></span><span class="t">            <span class="com">#No net effective precipitation (instead evaporation occurs)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t700" href="#t700">700</a></span><span class="t">            <span class="nam">evap</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">evaporate</span><span class="op">(</span><span class="op">-</span><span class="nam">total_water_passing_through_soil_tank</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t701" href="#t701">701</a></span><span class="t">            <span class="nam">subsurface_flow</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t702" href="#t702">702</a></span><span class="t">            <span class="nam">percolation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t703" href="#t703">703</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t704" href="#t704">704</a></span><span class="t">            <span class="key">if</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">evap</span> <span class="op">+</span> <span class="nam">infiltrated_precipitation</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">-</span> <span class="nam">evaporation</span> <span class="op">-</span> <span class="nam">infiltration_excess</span><span class="op">)</span> <span class="op">></span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t705" href="#t705">705</a></span><span class="t">                <span class="nam">print</span><span class="op">(</span><span class="str">'inaccurate evaporation calculation'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t706" href="#t706">706</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t707" href="#t707">707</a></span><span class="t">        <span class="com">#TODO saturation excess (think it should just be 'pull_ponded'  presumably in net effective precipitation? )</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t708" href="#t708">708</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t709" href="#t709">709</a></span><span class="t">        <span class="com">#Convert to VQIPs</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t710" href="#t710">710</a></span><span class="t">        <span class="nam">infiltration_excess</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">infiltration_excess</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t711" href="#t711">711</a></span><span class="t">        <span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">temperature</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t712" href="#t712">712</a></span><span class="t">        <span class="nam">precipitation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">precipitation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t713" href="#t713">713</a></span><span class="t">        <span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">evaporation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t714" href="#t714">714</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t715" href="#t715">715</a></span><span class="t">        <span class="com">#Track flows (these are sent onwards in the route function)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t716" href="#t716">716</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span> <span class="op">=</span> <span class="nam">infiltration_excess</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t717" href="#t717">717</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span> <span class="op">=</span> <span class="nam">subsurface_flow</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t718" href="#t718">718</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span> <span class="op">=</span> <span class="nam">percolation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t719" href="#t719">719</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">tank_recharge</span> <span class="op">=</span> <span class="nam">tank_recharge</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t720" href="#t720">720</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span> <span class="op">=</span> <span class="nam">evaporation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t721" href="#t721">721</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span> <span class="op">=</span> <span class="nam">precipitation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t722" href="#t722">722</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t723" href="#t723">723</a></span><span class="t">        <span class="com">#Mass balance</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t724" href="#t724">724</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">precipitation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t725" href="#t725">725</a></span><span class="t">        <span class="nam">out_</span> <span class="op">=</span> <span class="nam">evaporation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t726" href="#t726">726</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t727" href="#t727">727</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t728" href="#t728">728</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t729" href="#t729">729</a></span><span class="t">    <span class="key">def</span> <span class="nam">route</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t730" href="#t730">730</a></span><span class="t">        <span class="str">"""An outflow function that sends percolation, subsurface runoff and surface runoff to their respective tanks in the parent land node.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t731" href="#t731">731</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t732" href="#t732">732</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t733" href="#t733">733</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t734" href="#t734">734</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t735" href="#t735">735</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t736" href="#t736">736</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t737" href="#t737">737</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">surface_runoff</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t738" href="#t738">738</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">subsurface_runoff</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t739" href="#t739">739</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">percolation</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t740" href="#t740">740</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t741" href="#t741">741</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t742" href="#t742">742</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t743" href="#t743">743</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t744" href="#t744">744</a></span><span class="t">    <span class="key">def</span> <span class="nam">calculate_soil_temperature</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t745" href="#t745">745</a></span><span class="t">        <span class="str">"""Process function that calculates soil temperature based on a weighted </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t746" href="#t746">746</a></span><span class="t"><span class="str">        average. This equation is from Lindstrom, Bishop &amp; Lofvenius (2002), </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t747" href="#t747">747</a></span><span class="t"><span class="str">        hydrological processes - but it is not clear what the parameters should be.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t748" href="#t748">748</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t749" href="#t749">749</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t750" href="#t750">750</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t751" href="#t751">751</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t752" href="#t752">752</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t753" href="#t753">753</a></span><span class="t">        <span class="nam">auto</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_prev</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t754" href="#t754">754</a></span><span class="t">        <span class="nam">air</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'temperature'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_air</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t755" href="#t755">755</a></span><span class="t">        <span class="nam">total_weight</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_air</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_deep</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_prev</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t756" href="#t756">756</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="nam">auto</span> <span class="op">+</span> <span class="nam">air</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_deep</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">soil_temp_w_deep</span><span class="op">)</span><span class="op">/</span><span class="nam">total_weight</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t757" href="#t757">757</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t758" href="#t758">758</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t759" href="#t759">759</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t760" href="#t760">760</a></span><span class="t"><span class="key">class</span> <span class="nam">GrowingSurface</span><span class="op">(</span><span class="nam">PerviousSurface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t761" href="#t761">761</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t762" href="#t762">762</a></span><span class="t">                       <span class="nam">rooting_depth</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t763" href="#t763">763</a></span><span class="t">                        <span class="nam">ET_depletion_factor</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t764" href="#t764">764</a></span><span class="t">                        <span class="nam">crop_factor_stages</span> <span class="op">=</span> <span class="op">[</span><span class="num">1</span><span class="op">,</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t765" href="#t765">765</a></span><span class="t">                        <span class="nam">crop_factor_stage_dates</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span> <span class="num">365</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t766" href="#t766">766</a></span><span class="t">                        <span class="nam">sowing_day</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t767" href="#t767">767</a></span><span class="t">                        <span class="nam">harvest_day</span> <span class="op">=</span> <span class="num">365</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t768" href="#t768">768</a></span><span class="t">                        <span class="nam">initial_soil_storage</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t769" href="#t769">769</a></span><span class="t">                       <span class="op">**</span><span class="nam">kwargs</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t770" href="#t770">770</a></span><span class="t">                        <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t771" href="#t771">771</a></span><span class="t">        <span class="str">"""Extensive surface subclass that implements the CatchWat equations (Liu, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t772" href="#t772">772</a></span><span class="t"><span class="str">        Dobson &amp; Mijic (2022) Science of the total environment), which in turn are </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t773" href="#t773">773</a></span><span class="t"><span class="str">        primarily based on FAO document: </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t774" href="#t774">774</a></span><span class="t"><span class="str">        https://www.fao.org/3/x0490e/x0490e0ehtm#soil%20water%20availability. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t775" href="#t775">775</a></span><span class="t"><span class="str">        This surface is a pervious surface that also has things that grow on it. This </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t776" href="#t776">776</a></span><span class="t"><span class="str">        behaviour includes soil nutrient pools, crop planting/harvest calendars, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t777" href="#t777">777</a></span><span class="t"><span class="str">        erosion, crop behaviour.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t778" href="#t778">778</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t779" href="#t779">779</a></span><span class="t"><span class="str">        A key complexity of this surface is the nutrient pool (see wsimod/nodes/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t780" href="#t780">780</a></span><span class="t"><span class="str">        nutrient_pool.py), which is a class that tracks the amount of phosphorus and </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t781" href="#t781">781</a></span><span class="t"><span class="str">        nitrogen in different states and performs transformations that occur in the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t782" href="#t782">782</a></span><span class="t"><span class="str">        phosphorus/nitrogen cycle. It is assumed that the phosphate/nitrate/nitrite/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t783" href="#t783">783</a></span><span class="t"><span class="str">        ammonia amounts in this Surface tank should track the dissolved inorganic pool </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t784" href="#t784">784</a></span><span class="t"><span class="str">        in the nutrient pool. Meanwhile, the org-phosphorus/org-nitrogen amounts in </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t785" href="#t785">785</a></span><span class="t"><span class="str">        this tank should track the dissolved organic pool in the nutrient pool. The </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t786" href="#t786">786</a></span><span class="t"><span class="str">        total amount of pollutants that enter this tank may not be the same as the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t787" href="#t787">787</a></span><span class="t"><span class="str">        total amount that leave, because pollutants are transformed between inorganic/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t788" href="#t788">788</a></span><span class="t"><span class="str">        organic and between wet/dry states - these transformations are accounted for </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t789" href="#t789">789</a></span><span class="t"><span class="str">        in mass balance.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t790" href="#t790">790</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t791" href="#t791">791</a></span><span class="t"><span class="str">        For users to quickly enable/disable these nutrient processes, which are </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t792" href="#t792">792</a></span><span class="t"><span class="str">        computationally intensive (in current case studies they account for about half </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t793" href="#t793">793</a></span><span class="t"><span class="str">        of the total runtime), they are only active if 'nitrate' is one of the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t794" href="#t794">794</a></span><span class="t"><span class="str">        modelled pollutants. Note that the code will not check if nitrite/phosphate/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t795" href="#t795">795</a></span><span class="t"><span class="str">        org-phosphorus/org-nitrogen/ammonia are also included, but they should be if nitrate is included and otherwise the code will crash with a key error.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t796" href="#t796">796</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t797" href="#t797">797</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t798" href="#t798">798</a></span><span class="t"><span class="str">            rooting_depth (float, optional): Depth of the soil tank (i.e., how deep do </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t799" href="#t799">799</a></span><span class="t"><span class="str">                crop roots go). Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t800" href="#t800">800</a></span><span class="t"><span class="str">            ET_depletion_factor (float, optional): Average fraction of soil that can be </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t801" href="#t801">801</a></span><span class="t"><span class="str">                depleted from the root zone before moisture stress (reduction in ET) </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t802" href="#t802">802</a></span><span class="t"><span class="str">                occurs. Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t803" href="#t803">803</a></span><span class="t"><span class="str">            crop_factor_stages (list, optional): Crop factor is a multiplier on et0, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t804" href="#t804">804</a></span><span class="t"><span class="str">                more grown plants have higher transpiration and higher crop factors.   </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t805" href="#t805">805</a></span><span class="t"><span class="str">                This list shows changing crop factor at different times of year in </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t806" href="#t806">806</a></span><span class="t"><span class="str">                relation to crop_factor_stage_dates. See wsimod/preprocessing/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t807" href="#t807">807</a></span><span class="t"><span class="str">                england_data_formatting.py/format_surfaces for further details on </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t808" href="#t808">808</a></span><span class="t"><span class="str">                formulating these - since the interpolation used to find crop_factors </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t809" href="#t809">809</a></span><span class="t"><span class="str">                in between the given values in the list is a bit involved. Defaults to </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t810" href="#t810">810</a></span><span class="t"><span class="str">                [1,1].</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t811" href="#t811">811</a></span><span class="t"><span class="str">            crop_factor_stage_dates (list, optional): Dates associated with </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t812" href="#t812">812</a></span><span class="t"><span class="str">                crop_factor_stages. Defaults to [0, 365].</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t813" href="#t813">813</a></span><span class="t"><span class="str">            sowing_day (int, optional): day of year that crops are sown. Defaults to 1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t814" href="#t814">814</a></span><span class="t"><span class="str">            harvest_day (int, optional): day of year that crops are harvest. Defaults </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t815" href="#t815">815</a></span><span class="t"><span class="str">                to 365.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t816" href="#t816">816</a></span><span class="t"><span class="str">            initial_soil_storage (dict or float, optional): Initial mass of solid pollutants</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t817" href="#t817">817</a></span><span class="t"><span class="str">                in the soil nutrient pools (fast and adsorbed inorganic pools)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t818" href="#t818">818</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t819" href="#t819">819</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t820" href="#t820">820</a></span><span class="t">        <span class="com">#Crop factors (set when creating object)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t821" href="#t821">821</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ET_depletion_factor</span> <span class="op">=</span> <span class="nam">ET_depletion_factor</span> <span class="com">#To do with water availability, p from FAOSTAT</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t822" href="#t822">822</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span> <span class="op">=</span> <span class="nam">rooting_depth</span> <span class="com">#maximum depth that plants can absorb, Zr from FAOSTAT</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t823" href="#t823">823</a></span><span class="t">        <span class="nam">depth</span> <span class="op">=</span> <span class="nam">rooting_depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t824" href="#t824">824</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t825" href="#t825">825</a></span><span class="t">        <span class="com">#Crop parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t826" href="#t826">826</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover_max</span> <span class="op">=</span> <span class="num">0.9</span> <span class="com"># [-] 0~1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t827" href="#t827">827</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover_max</span> <span class="op">=</span> <span class="num">0.3</span> <span class="com"># [-]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t828" href="#t828">828</a></span><span class="t">        <span class="com">#TODO... really I should just have this as an annual profile parameter and do away with interpolation etc.</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t829" href="#t829">829</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor_stages</span> <span class="op">=</span> <span class="nam">crop_factor_stages</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t830" href="#t830">830</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor_stage_dates</span> <span class="op">=</span> <span class="nam">crop_factor_stage_dates</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t831" href="#t831">831</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">sowing_day</span> <span class="op">=</span> <span class="nam">sowing_day</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t832" href="#t832">832</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_day</span> <span class="op">=</span> <span class="nam">harvest_day</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t833" href="#t833">833</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t834" href="#t834">834</a></span><span class="t">        <span class="com">#Soil moisture dependence parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t835" href="#t835">835</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">satact</span> <span class="op">=</span> <span class="num">0.6</span> <span class="com"># [-] for calculating soil_moisture_dependence_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t836" href="#t836">836</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">thetaupp</span> <span class="op">=</span> <span class="num">0.12</span> <span class="com"># [-] for calculating soil_moisture_dependence_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t837" href="#t837">837</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">thetalow</span> <span class="op">=</span> <span class="num">0.08</span> <span class="com"># [-] for calculating soil_moisture_dependence_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t838" href="#t838">838</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">thetapow</span> <span class="op">=</span> <span class="num">1</span> <span class="com"># [-] for calculating soil_moisture_dependence_factorself.satact = 0.6 # [-] for calculating soil_moisture_dependence_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t839" href="#t839">839</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t840" href="#t840">840</a></span><span class="t">        <span class="com">#Crop uptake parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t841" href="#t841">841</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">uptake1</span> <span class="op">=</span> <span class="num">15</span> <span class="com"># [g/m2/y] shape factor for crop (Dissolved) Inorganic nitrogen uptake</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t842" href="#t842">842</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">uptake2</span> <span class="op">=</span> <span class="num">1</span> <span class="com"># [-] shape factor for crop (Dissolved) Inorganic nitrogen uptake</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t843" href="#t843">843</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">uptake3</span> <span class="op">=</span> <span class="num">0.02</span> <span class="com"># [1/day] shape factor for crop (Dissolved) Inorganic nitrogen uptake</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t844" href="#t844">844</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">uptake_PNratio</span> <span class="op">=</span> <span class="num">1</span><span class="op">/</span><span class="num">7.2</span> <span class="com"># [-] P:N during crop uptake</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t845" href="#t845">845</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t846" href="#t846">846</a></span><span class="t">        <span class="com">#Erosion parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t847" href="#t847">847</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">erodibility</span> <span class="op">=</span> <span class="num">0.0025</span> <span class="com"># [g * d / (J * mm)]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t848" href="#t848">848</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">sreroexp</span> <span class="op">=</span> <span class="num">1.2</span> <span class="com"># [-] surface runoff erosion exponent</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t849" href="#t849">849</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">cohesion</span> <span class="op">=</span> <span class="num">1</span> <span class="com"># [kPa]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t850" href="#t850">850</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">slope</span> <span class="op">=</span> <span class="num">5</span> <span class="com"># [-] every 100</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t851" href="#t851">851</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">srfilt</span> <span class="op">=</span> <span class="num">0.95</span> <span class="com"># [-] ratio of eroded sediment left in surface runoff after filtration</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t852" href="#t852">852</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">macrofilt</span> <span class="op">=</span> <span class="num">0.1</span> <span class="com"># [-] ratio of eroded sediment left in subsurface flow after filtration</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t853" href="#t853">853</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t854" href="#t854">854</a></span><span class="t">        <span class="com">#Denitrification parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t855" href="#t855">855</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">limpar</span> <span class="op">=</span> <span class="num">0.7</span> <span class="com"># [-] above which denitrification begins</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t856" href="#t856">856</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">exppar</span> <span class="op">=</span> <span class="num">2.5</span> <span class="com"># [-] exponential parameter for soil_moisture_dependence_factor_exp calculation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t857" href="#t857">857</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">hsatINs</span> <span class="op">=</span> <span class="num">1</span> <span class="com"># [mg/l] for calculation of half-saturation concentration dependence factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t858" href="#t858">858</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">denpar</span> <span class="op">=</span> <span class="num">0.015</span> <span class="com"># [-] denitrification rate coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t859" href="#t859">859</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t860" href="#t860">860</a></span><span class="t">        <span class="com">#Adsorption parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t861" href="#t861">861</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">adosorption_nr_limit</span> <span class="op">=</span> <span class="num">0.00001</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t862" href="#t862">862</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">adsorption_nr_maxiter</span> <span class="op">=</span> <span class="num">20</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t863" href="#t863">863</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">kfr</span> <span class="op">=</span> <span class="num">153.7</span> <span class="com"># [1/kg] freundlich adsorption isoterm</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t864" href="#t864">864</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span> <span class="op">=</span> <span class="num">1</span><span class="op">/</span><span class="num">2.6</span> <span class="com"># [-] freundlich exponential coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t865" href="#t865">865</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">kadsdes</span> <span class="op">=</span> <span class="num">0.03</span> <span class="com"># [1/day] adsorption/desorption coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t866" href="#t866">866</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t867" href="#t867">867</a></span><span class="t">        <span class="com">#Other soil parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t868" href="#t868">868</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">bulk_density</span> <span class="op">=</span> <span class="num">1300</span> <span class="com"># [kg/m3]        </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t869" href="#t869">869</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="nam">depth</span> <span class="op">=</span> <span class="nam">depth</span><span class="op">,</span><span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t870" href="#t870">870</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t871" href="#t871">871</a></span><span class="t">        <span class="com">#Infer basic sow/harvest calendar        </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t872" href="#t872">872</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_sow_calendar</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sowing_day</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_day</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_day</span> <span class="op">+</span> <span class="num">1</span><span class="op">,</span> <span class="num">365</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t873" href="#t873">873</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover_stages</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span><span class="num">0</span><span class="op">,</span><span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover_max</span><span class="op">,</span><span class="num">0</span><span class="op">,</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t874" href="#t874">874</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover_stages</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span><span class="num">0</span><span class="op">,</span><span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover_max</span><span class="op">,</span><span class="num">0</span><span class="op">,</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t875" href="#t875">875</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t876" href="#t876">876</a></span><span class="t">        <span class="com">#This is just based on googling when is autumn...</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t877" href="#t877">877</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sowing_day</span> <span class="op">></span> <span class="num">265</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t878" href="#t878">878</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">autumn_sow</span> <span class="op">=</span> <span class="key">True</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t879" href="#t879">879</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t880" href="#t880">880</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">autumn_sow</span> <span class="op">=</span> <span class="key">False</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t881" href="#t881">881</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t882" href="#t882">882</a></span><span class="t">        <span class="com">#State variables</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t883" href="#t883">883</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t884" href="#t884">884</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t885" href="#t885">885</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t886" href="#t886">886</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t887" href="#t887">887</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">et0_coefficient</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t888" href="#t888">888</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t889" href="#t889">889</a></span><span class="t">        <span class="com">#Calculate parameters based on capacity/wp</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t890" href="#t890">890</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">total_available_water</span> <span class="op">=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">wilting_point</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t891" href="#t891">891</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_available_water</span> <span class="op">&lt;</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t892" href="#t892">892</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">'warning: TAW &lt; 0...'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t893" href="#t893">893</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">readily_available_water</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_available_water</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ET_depletion_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t894" href="#t894">894</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t895" href="#t895">895</a></span><span class="t">        <span class="com">#Initiliase nutrient pools</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t896" href="#t896">896</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span> <span class="op">=</span> <span class="nam">NutrientPool</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t897" href="#t897">897</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t898" href="#t898">898</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span><span class="op">.</span><span class="nam">insert</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">calc_crop_cover</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t899" href="#t899">899</a></span><span class="t">        <span class="key">if</span> <span class="str">'nitrate'</span> <span class="key">in</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">POLLUTANTS</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t900" href="#t900">900</a></span><span class="t">            <span class="com">#Populate function lists </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t901" href="#t901">901</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">fertiliser</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t902" href="#t902">902</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">inflows</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">manure</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t903" href="#t903">903</a></span><span class="t">            <span class="com"># self.inflows.append(self.residue)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t904" href="#t904">904</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t905" href="#t905">905</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">calc_temperature_dependence_factor</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t906" href="#t906">906</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">calc_soil_moisture_dependence_factor</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t907" href="#t907">907</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">soil_pool_transformation</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t908" href="#t908">908</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">calc_crop_uptake</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t909" href="#t909">909</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t910" href="#t910">910</a></span><span class="t">            <span class="com"># TODO possibly move these into nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t911" href="#t911">911</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">erosion</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t912" href="#t912">912</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">denitrification</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t913" href="#t913">913</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">processes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">adsorption</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t914" href="#t914">914</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t915" href="#t915">915</a></span><span class="t">            <span class="com">#Reflect initial water concentration in dissolved nutrient pools</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t916" href="#t916">916</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t917" href="#t917">917</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t918" href="#t918">918</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_organic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t919" href="#t919">919</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_organic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t920" href="#t920">920</a></span><span class="t">            <span class="key">if</span> <span class="nam">initial_soil_storage</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t921" href="#t921">921</a></span><span class="t">                <span class="com">#Reflect initial nutrient stores in solid nutrient pools</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t922" href="#t922">922</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">adsorbed_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">initial_soil_storage</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t923" href="#t923">923</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">adsorbed_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">initial_soil_storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">initial_soil_storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">initial_soil_storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t924" href="#t924">924</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fast_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">initial_soil_storage</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t925" href="#t925">925</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fast_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">initial_soil_storage</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t926" href="#t926">926</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t927" href="#t927">927</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t928" href="#t928">928</a></span><span class="t">    <span class="key">def</span> <span class="nam">pull_storage</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t929" href="#t929">929</a></span><span class="t">        <span class="str">"""Pull water from the surface, updating the surface storage VQIP. Nutrient </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t930" href="#t930">930</a></span><span class="t"><span class="str">        pool pollutants (nitrate/nitrite/ammonia/phosphate/org-phosphorus/</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t931" href="#t931">931</a></span><span class="t"><span class="str">        org-nitrogen) are removed in proportion to their amounts in the dissolved </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t932" href="#t932">932</a></span><span class="t"><span class="str">        nutrient pools, if they are simulated. Other pollutants are removed in proportion to their amount in the surface tank.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t933" href="#t933">933</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t934" href="#t934">934</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t935" href="#t935">935</a></span><span class="t"><span class="str">            vqip (dict): VQIP amount to be pulled, (only 'volume' key is needed)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t936" href="#t936">936</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t937" href="#t937">937</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t938" href="#t938">938</a></span><span class="t"><span class="str">            reply (dict): A VQIP amount successfully pulled from the tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t939" href="#t939">939</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t940" href="#t940">940</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t941" href="#t941">941</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t942" href="#t942">942</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t943" href="#t943">943</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t944" href="#t944">944</a></span><span class="t">        <span class="com">#Adjust based on available volume</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t945" href="#t945">945</a></span><span class="t">        <span class="nam">reply</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="nam">vqip</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t946" href="#t946">946</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t947" href="#t947">947</a></span><span class="t">        <span class="com">#Update reply to vqip (get concentration for non-nutrients)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t948" href="#t948">948</a></span><span class="t">        <span class="nam">reply</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">v_change_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">,</span> <span class="nam">reply</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t949" href="#t949">949</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t950" href="#t950">950</a></span><span class="t">        <span class="key">if</span> <span class="str">'nitrate'</span> <span class="key">in</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">POLLUTANTS</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t951" href="#t951">951</a></span><span class="t">            <span class="com">#Update nutrient pool and get concentration for nutrients</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t952" href="#t952">952</a></span><span class="t">            <span class="nam">prop</span> <span class="op">=</span> <span class="nam">reply</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t953" href="#t953">953</a></span><span class="t">            <span class="nam">nutrients</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">extract_dissolved</span><span class="op">(</span><span class="nam">prop</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t954" href="#t954">954</a></span><span class="t">            <span class="nam">reply</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nutrients</span><span class="op">[</span><span class="str">'inorganic'</span><span class="op">]</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t955" href="#t955">955</a></span><span class="t">            <span class="nam">reply</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nutrients</span><span class="op">[</span><span class="str">'inorganic'</span><span class="op">]</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t956" href="#t956">956</a></span><span class="t">            <span class="nam">reply</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nutrients</span><span class="op">[</span><span class="str">'inorganic'</span><span class="op">]</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrite'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t957" href="#t957">957</a></span><span class="t">            <span class="nam">reply</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nutrients</span><span class="op">[</span><span class="str">'inorganic'</span><span class="op">]</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t958" href="#t958">958</a></span><span class="t">            <span class="nam">reply</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nutrients</span><span class="op">[</span><span class="str">'organic'</span><span class="op">]</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t959" href="#t959">959</a></span><span class="t">            <span class="nam">reply</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nutrients</span><span class="op">[</span><span class="str">'organic'</span><span class="op">]</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t960" href="#t960">960</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t961" href="#t961">961</a></span><span class="t">        <span class="com">#Extract from storage</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t962" href="#t962">962</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">extract_vqip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">,</span> <span class="nam">reply</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t963" href="#t963">963</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t964" href="#t964">964</a></span><span class="t">        <span class="key">return</span> <span class="nam">reply</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t965" href="#t965">965</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t966" href="#t966">966</a></span><span class="t">    <span class="key">def</span> <span class="nam">quick_interp</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">x</span><span class="op">,</span> <span class="nam">xp</span><span class="op">,</span> <span class="nam">yp</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t967" href="#t967">967</a></span><span class="t">        <span class="str">"""A simple version of np.interp to intepolate crop information on the fly</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t968" href="#t968">968</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t969" href="#t969">969</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t970" href="#t970">970</a></span><span class="t"><span class="str">            x (int): Current time (i.e., day of year)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t971" href="#t971">971</a></span><span class="t"><span class="str">            xp (list): Predefined times (i.e., list of days of year)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t972" href="#t972">972</a></span><span class="t"><span class="str">            yp (list): Predefined values associated with xp</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t973" href="#t973">973</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t974" href="#t974">974</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t975" href="#t975">975</a></span><span class="t"><span class="str">            y (float): Interpolated value for current time</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t976" href="#t976">976</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t977" href="#t977">977</a></span><span class="t">        <span class="nam">x_ind</span> <span class="op">=</span> <span class="nam">bisect_left</span><span class="op">(</span><span class="nam">xp</span><span class="op">,</span> <span class="nam">x</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t978" href="#t978">978</a></span><span class="t">        <span class="nam">x_left</span> <span class="op">=</span> <span class="nam">xp</span><span class="op">[</span><span class="nam">x_ind</span> <span class="op">-</span> <span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t979" href="#t979">979</a></span><span class="t">        <span class="nam">x_right</span> <span class="op">=</span> <span class="nam">xp</span><span class="op">[</span><span class="nam">x_ind</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t980" href="#t980">980</a></span><span class="t">        <span class="nam">dif</span> <span class="op">=</span> <span class="nam">x</span> <span class="op">-</span> <span class="nam">x_left</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t981" href="#t981">981</a></span><span class="t">        <span class="nam">y_left</span> <span class="op">=</span> <span class="nam">yp</span><span class="op">[</span><span class="nam">x_ind</span> <span class="op">-</span> <span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t982" href="#t982">982</a></span><span class="t">        <span class="nam">y_right</span> <span class="op">=</span> <span class="nam">yp</span><span class="op">[</span><span class="nam">x_ind</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t983" href="#t983">983</a></span><span class="t">        <span class="nam">y</span> <span class="op">=</span> <span class="nam">y_left</span> <span class="op">+</span> <span class="op">(</span><span class="nam">y_right</span> <span class="op">-</span> <span class="nam">y_left</span><span class="op">)</span> <span class="op">*</span> <span class="nam">dif</span> <span class="op">/</span> <span class="op">(</span><span class="nam">x_right</span> <span class="op">-</span> <span class="nam">x_left</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t984" href="#t984">984</a></span><span class="t">        <span class="key">return</span> <span class="nam">y</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t985" href="#t985">985</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t986" href="#t986">986</a></span><span class="t">    <span class="key">def</span> <span class="nam">calc_crop_cover</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t987" href="#t987">987</a></span><span class="t">        <span class="str">"""Process function that calculates how much crop cover there is, assigns </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t988" href="#t988">988</a></span><span class="t"><span class="str">        whether crops are sown/harvested, and calculates et0_coefficient based on </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t989" href="#t989">989</a></span><span class="t"><span class="str">        growth stage of crops.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t990" href="#t990">990</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t991" href="#t991">991</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t992" href="#t992">992</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t993" href="#t993">993</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t994" href="#t994">994</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t995" href="#t995">995</a></span><span class="t">        <span class="com">#Get current day of year</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t996" href="#t996">996</a></span><span class="t">        <span class="nam">doy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">t</span><span class="op">.</span><span class="nam">dayofyear</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t997" href="#t997">997</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t998" href="#t998">998</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">t</span><span class="op">.</span><span class="nam">is_leap_year</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t999" href="#t999">999</a></span><span class="t">            <span class="com">#Hacky way to handle leap years</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1000" href="#t1000">1000</a></span><span class="t">            <span class="key">if</span> <span class="nam">doy</span> <span class="op">></span> <span class="num">59</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1001" href="#t1001">1001</a></span><span class="t">                <span class="nam">doy</span> <span class="op">-=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1002" href="#t1002">1002</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1003" href="#t1003">1003</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1004" href="#t1004">1004</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">t</span><span class="op">.</span><span class="nam">dayofyear</span> <span class="op">==</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sowing_day</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1005" href="#t1005">1005</a></span><span class="t">                <span class="com">#sow</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1006" href="#t1006">1006</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1007" href="#t1007">1007</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1008" href="#t1008">1008</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">t</span><span class="op">.</span><span class="nam">dayofyear</span> <span class="op">==</span> <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_day</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1009" href="#t1009">1009</a></span><span class="t">                <span class="com">#harvest</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1010" href="#t1010">1010</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1011" href="#t1011">1011</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor_stages</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1012" href="#t1012">1012</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1013" href="#t1013">1013</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1014" href="#t1014">1014</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1015" href="#t1015">1015</a></span><span class="t">                <span class="com">#increment days since sow</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1016" href="#t1016">1016</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1017" href="#t1017">1017</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1018" href="#t1018">1018</a></span><span class="t">        <span class="com">#Calculate relevant parameters</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1019" href="#t1019">1019</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">quick_interp</span><span class="op">(</span><span class="nam">doy</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor_stage_dates</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor_stages</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1020" href="#t1020">1020</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1021" href="#t1021">1021</a></span><span class="t">            <span class="com">#Move outside of this if, if you want nonzero crop/ground cover outside of season</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1022" href="#t1022">1022</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">quick_interp</span><span class="op">(</span><span class="nam">doy</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_sow_calendar</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover_stages</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1023" href="#t1023">1023</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">quick_interp</span><span class="op">(</span><span class="nam">doy</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">harvest_sow_calendar</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover_stages</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1024" href="#t1024">1024</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1025" href="#t1025">1025</a></span><span class="t">        <span class="nam">root_zone_depletion</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_smc</span><span class="op">(</span><span class="op">)</span><span class="op">,</span><span class="num">0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1026" href="#t1026">1026</a></span><span class="t">        <span class="key">if</span> <span class="nam">root_zone_depletion</span> <span class="op">&lt;</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readily_available_water</span> <span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1027" href="#t1027">1027</a></span><span class="t">            <span class="nam">crop_water_stress_coefficient</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1028" href="#t1028">1028</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1029" href="#t1029">1029</a></span><span class="t">            <span class="nam">crop_water_stress_coefficient</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">total_available_water</span> <span class="op">-</span> <span class="nam">root_zone_depletion</span><span class="op">)</span> <span class="op">/</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1030" href="#t1030">1030</a></span><span class="t">                                                <span class="op">(</span><span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ET_depletion_factor</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">total_available_water</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1031" href="#t1031">1031</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1032" href="#t1032">1032</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">et0_coefficient</span> <span class="op">=</span> <span class="nam">crop_water_stress_coefficient</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">crop_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1033" href="#t1033">1033</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1034" href="#t1034">1034</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1035" href="#t1035">1035</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1036" href="#t1036">1036</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1037" href="#t1037">1037</a></span><span class="t">    <span class="key">def</span> <span class="nam">adjust_vqip_to_liquid</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">,</span> <span class="nam">deposition</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1038" href="#t1038">1038</a></span><span class="t">        <span class="str">"""Function to interoperate between surface tank and nutrient pool. Most </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1039" href="#t1039">1039</a></span><span class="t"><span class="str">        depositions are given in terms of ammonia/nitrate/phosphate - they are then </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1040" href="#t1040">1040</a></span><span class="t"><span class="str">        aggregated to total N or P to enter the nutrient pools. Depending on the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1041" href="#t1041">1041</a></span><span class="t"><span class="str">        source of deposition these may transform (e.g., some go to dissolved and some </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1042" href="#t1042">1042</a></span><span class="t"><span class="str">        to solids) upon entering the nutrient pool. To reflect these transformations </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1043" href="#t1043">1043</a></span><span class="t"><span class="str">        in the soil tank, the amounts entering the soil tank are adjusted </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1044" href="#t1044">1044</a></span><span class="t"><span class="str">        proportionately.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1045" href="#t1045">1045</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1046" href="#t1046">1046</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1047" href="#t1047">1047</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of pollutants originally intended to enter the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1048" href="#t1048">1048</a></span><span class="t"><span class="str">                soil tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1049" href="#t1049">1049</a></span><span class="t"><span class="str">            deposition (dict): A dict with nutrients (N and P) as keys, showing the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1050" href="#t1050">1050</a></span><span class="t"><span class="str">                total amount of nutrients entering the nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1051" href="#t1051">1051</a></span><span class="t"><span class="str">            in_ (dict): A dict with nutrients as keys, showing the updated amount of </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1052" href="#t1052">1052</a></span><span class="t"><span class="str">                nutrients that entered the nutrient pool as dissolved pollutants</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1053" href="#t1053">1053</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1054" href="#t1054">1054</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1055" href="#t1055">1055</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of pollutants that have been scaled to account </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1056" href="#t1056">1056</a></span><span class="t"><span class="str">                for nutrient pool transformations</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1057" href="#t1057">1057</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1058" href="#t1058">1058</a></span><span class="t">        <span class="key">if</span> <span class="str">'nitrate'</span> <span class="key">in</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">POLLUTANTS</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1059" href="#t1059">1059</a></span><span class="t">            <span class="key">if</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1060" href="#t1060">1060</a></span><span class="t">                <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">in_</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1061" href="#t1061">1061</a></span><span class="t">                <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">in_</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1062" href="#t1062">1062</a></span><span class="t">                <span class="nam">vqip</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">in_</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1063" href="#t1063">1063</a></span><span class="t">            <span class="key">if</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1064" href="#t1064">1064</a></span><span class="t">                <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">in_</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1065" href="#t1065">1065</a></span><span class="t">                <span class="nam">vqip</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">in_</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1066" href="#t1066">1066</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1067" href="#t1067">1067</a></span><span class="t">        <span class="key">return</span> <span class="nam">vqip</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1068" href="#t1068">1068</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1069" href="#t1069">1069</a></span><span class="t">    <span class="key">def</span> <span class="nam">fertiliser</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1070" href="#t1070">1070</a></span><span class="t">        <span class="str">"""Read, scale and allocate fertiliser, updating the tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1071" href="#t1071">1071</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1072" href="#t1072">1072</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1073" href="#t1073">1073</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1074" href="#t1074">1074</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1075" href="#t1075">1075</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1076" href="#t1076">1076</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1077" href="#t1077">1077</a></span><span class="t">        <span class="com">#TODO tidy up fertiliser/manure/residue/deposition once preprocessing is sorted</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1078" href="#t1078">1078</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1079" href="#t1079">1079</a></span><span class="t">        <span class="com">#Scale for surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1080" href="#t1080">1080</a></span><span class="t">        <span class="nam">nhx</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'nhx-fertiliser'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1081" href="#t1081">1081</a></span><span class="t">        <span class="nam">noy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'noy-fertiliser'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1082" href="#t1082">1082</a></span><span class="t">        <span class="nam">srp</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'srp-fertiliser'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1083" href="#t1083">1083</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1084" href="#t1084">1084</a></span><span class="t">        <span class="com">#Update as VQIP</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1085" href="#t1085">1085</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1086" href="#t1086">1086</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nhx</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1087" href="#t1087">1087</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">noy</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1088" href="#t1088">1088</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">srp</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1089" href="#t1089">1089</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1090" href="#t1090">1090</a></span><span class="t">        <span class="com">#Enter nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1091" href="#t1091">1091</a></span><span class="t">        <span class="nam">deposition</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1092" href="#t1092">1092</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1093" href="#t1093">1093</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1094" href="#t1094">1094</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_fertiliser</span><span class="op">(</span><span class="nam">deposition</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1095" href="#t1095">1095</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1096" href="#t1096">1096</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1097" href="#t1097">1097</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adjust_vqip_to_liquid</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">deposition</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1098" href="#t1098">1098</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1099" href="#t1099">1099</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1100" href="#t1100">1100</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1101" href="#t1101">1101</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1102" href="#t1102">1102</a></span><span class="t">    <span class="key">def</span> <span class="nam">manure</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1103" href="#t1103">1103</a></span><span class="t">        <span class="str">"""Read, scale and allocate manure, updating the tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1104" href="#t1104">1104</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1105" href="#t1105">1105</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1106" href="#t1106">1106</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1107" href="#t1107">1107</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1108" href="#t1108">1108</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1109" href="#t1109">1109</a></span><span class="t">        <span class="com">#Scale for surface</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1110" href="#t1110">1110</a></span><span class="t">        <span class="nam">nhx</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'nhx-manure'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1111" href="#t1111">1111</a></span><span class="t">        <span class="nam">noy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'noy-manure'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1112" href="#t1112">1112</a></span><span class="t">        <span class="nam">srp</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'srp-manure'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1113" href="#t1113">1113</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1114" href="#t1114">1114</a></span><span class="t">        <span class="com">#Formulate as VQIP</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1115" href="#t1115">1115</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1116" href="#t1116">1116</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nhx</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1117" href="#t1117">1117</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">noy</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1118" href="#t1118">1118</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">srp</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1119" href="#t1119">1119</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1120" href="#t1120">1120</a></span><span class="t">        <span class="com">#Enter nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1121" href="#t1121">1121</a></span><span class="t">        <span class="nam">deposition</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1122" href="#t1122">1122</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1123" href="#t1123">1123</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1124" href="#t1124">1124</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_manure</span><span class="op">(</span><span class="nam">deposition</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1125" href="#t1125">1125</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1126" href="#t1126">1126</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1127" href="#t1127">1127</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adjust_vqip_to_liquid</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">deposition</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1128" href="#t1128">1128</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1129" href="#t1129">1129</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1130" href="#t1130">1130</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1131" href="#t1131">1131</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1132" href="#t1132">1132</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1133" href="#t1133">1133</a></span><span class="t">    <span class="key">def</span> <span class="nam">residue</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1134" href="#t1134">1134</a></span><span class="t">        <span class="str">"""Read, scale and allocate residue, updating the tank (NOT CURRENTLY USED </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1135" href="#t1135">1135</a></span><span class="t"><span class="str">        BECAUSE NO DATA SOURCES FOR RESIDUE CAN BE IDENTIFIED)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1136" href="#t1136">1136</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1137" href="#t1137">1137</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1138" href="#t1138">1138</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1139" href="#t1139">1139</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1140" href="#t1140">1140</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1141" href="#t1141">1141</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1142" href="#t1142">1142</a></span><span class="t">        <span class="nam">nhx</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'nhx-residue'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1143" href="#t1143">1143</a></span><span class="t">        <span class="nam">noy</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'noy-residue'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1144" href="#t1144">1144</a></span><span class="t">        <span class="nam">srp</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input_surface</span><span class="op">(</span><span class="str">'srp-residue'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1145" href="#t1145">1145</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1146" href="#t1146">1146</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1147" href="#t1147">1147</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">nhx</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fraction_residue_to_fast</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1148" href="#t1148">1148</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">noy</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fraction_residue_to_fast</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1149" href="#t1149">1149</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="nam">nhx</span> <span class="op">+</span> <span class="nam">noy</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fraction_residue_to_humus</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1150" href="#t1150">1150</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">srp</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fraction_residue_to_fast</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1151" href="#t1151">1151</a></span><span class="t">        <span class="nam">vqip</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">srp</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">fraction_residue_to_humus</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1152" href="#t1152">1152</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1153" href="#t1153">1153</a></span><span class="t">        <span class="nam">deposition</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1154" href="#t1154">1154</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1155" href="#t1155">1155</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1156" href="#t1156">1156</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1157" href="#t1157">1157</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_residue</span><span class="op">(</span><span class="nam">deposition</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1158" href="#t1158">1158</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adjust_vqip_to_liquid</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">deposition</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1159" href="#t1159">1159</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1160" href="#t1160">1160</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1161" href="#t1161">1161</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1162" href="#t1162">1162</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1163" href="#t1163">1163</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1164" href="#t1164">1164</a></span><span class="t">    <span class="key">def</span> <span class="nam">soil_pool_transformation</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1165" href="#t1165">1165</a></span><span class="t">        <span class="str">"""A process function that run transformation functions in the nutrient pool </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1166" href="#t1166">1166</a></span><span class="t"><span class="str">        and updates the pollutant concentrations in the surface tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1167" href="#t1167">1167</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1168" href="#t1168">1168</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1169" href="#t1169">1169</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1170" href="#t1170">1170</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1171" href="#t1171">1171</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1172" href="#t1172">1172</a></span><span class="t">        <span class="com">#Initialise mass balance tracking variables</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1173" href="#t1173">1173</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1174" href="#t1174">1174</a></span><span class="t">        <span class="nam">out_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1175" href="#t1175">1175</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1176" href="#t1176">1176</a></span><span class="t">        <span class="com">#Get proportion of nitrogen that is nitrate in the soil tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1177" href="#t1177">1177</a></span><span class="t">        <span class="com">#NOTE ignores nitrite - couldn't find enough information on it</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1178" href="#t1178">1178</a></span><span class="t">        <span class="nam">nitrate_proportion</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1179" href="#t1179">1179</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1180" href="#t1180">1180</a></span><span class="t">        <span class="com">#Run soil pool functions</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1181" href="#t1181">1181</a></span><span class="t">        <span class="nam">increase_in_dissolved_inorganic</span><span class="op">,</span> <span class="nam">increase_in_dissolved_organic</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">soil_pool_transformation</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1182" href="#t1182">1182</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1183" href="#t1183">1183</a></span><span class="t">        <span class="com">#Update tank and mass balance</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1184" href="#t1184">1184</a></span><span class="t">        <span class="com">#TODO .. there is definitely a neater way to write  this</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1185" href="#t1185">1185</a></span><span class="t">        <span class="key">if</span> <span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1186" href="#t1186">1186</a></span><span class="t">            <span class="com">#Increase in inorganic nitrogen, rescale back to nitrate and ammonia</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1187" href="#t1187">1187</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">nitrate_proportion</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1188" href="#t1188">1188</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">nitrate_proportion</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1189" href="#t1189">1189</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1190" href="#t1190">1190</a></span><span class="t">            <span class="com">#Decrease in inorganic nitrogen, rescale back to nitrate and ammonia</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1191" href="#t1191">1191</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">nitrate_proportion</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1192" href="#t1192">1192</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">nitrate_proportion</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1193" href="#t1193">1193</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1194" href="#t1194">1194</a></span><span class="t">        <span class="key">if</span> <span class="nam">increase_in_dissolved_organic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1195" href="#t1195">1195</a></span><span class="t">            <span class="com">#Increase in organic nitrogen</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1196" href="#t1196">1196</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">increase_in_dissolved_organic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1197" href="#t1197">1197</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1198" href="#t1198">1198</a></span><span class="t">            <span class="com">#Decrease in organic nitrogen</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1199" href="#t1199">1199</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="nam">increase_in_dissolved_organic</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1200" href="#t1200">1200</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1201" href="#t1201">1201</a></span><span class="t">        <span class="key">if</span> <span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1202" href="#t1202">1202</a></span><span class="t">            <span class="com">#Increase in inorganic phosphate</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1203" href="#t1203">1203</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1204" href="#t1204">1204</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1205" href="#t1205">1205</a></span><span class="t">            <span class="com">#Decrease in inorganic phosphate</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1206" href="#t1206">1206</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="nam">increase_in_dissolved_inorganic</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1207" href="#t1207">1207</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1208" href="#t1208">1208</a></span><span class="t">        <span class="key">if</span> <span class="nam">increase_in_dissolved_organic</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1209" href="#t1209">1209</a></span><span class="t">            <span class="com">#Increase in organic phosphorus</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1210" href="#t1210">1210</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">increase_in_dissolved_organic</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1211" href="#t1211">1211</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1212" href="#t1212">1212</a></span><span class="t">            <span class="com">#Decrease in organic phosphorus</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1213" href="#t1213">1213</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="nam">increase_in_dissolved_organic</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1214" href="#t1214">1214</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1215" href="#t1215">1215</a></span><span class="t">        <span class="com">#Update tank with inputs/outputs of pollutants</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1216" href="#t1216">1216</a></span><span class="t">        <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1217" href="#t1217">1217</a></span><span class="t">        <span class="nam">out2_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_pollutants</span><span class="op">(</span><span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1218" href="#t1218">1218</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1219" href="#t1219">1219</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">compare_vqip</span><span class="op">(</span><span class="nam">out_</span><span class="op">,</span> <span class="nam">out2_</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1220" href="#t1220">1220</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">'nutrient pool not tracking soil tank'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1221" href="#t1221">1221</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1222" href="#t1222">1222</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1223" href="#t1223">1223</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1224" href="#t1224">1224</a></span><span class="t">    <span class="key">def</span> <span class="nam">calc_temperature_dependence_factor</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1225" href="#t1225">1225</a></span><span class="t">        <span class="str">"""Process function that calculates the temperature dependence factor for the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1226" href="#t1226">1226</a></span><span class="t"><span class="str">        nutrient pool (which impacts soil pool transformations)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1227" href="#t1227">1227</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1228" href="#t1228">1228</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1229" href="#t1229">1229</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1230" href="#t1230">1230</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1231" href="#t1231">1231</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1232" href="#t1232">1232</a></span><span class="t">        <span class="com">#Parameters/equations from HYPE documentation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1233" href="#t1233">1233</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">></span> <span class="num">5</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1234" href="#t1234">1234</a></span><span class="t">            <span class="nam">temperature_dependence_factor</span> <span class="op">=</span> <span class="num">2</span> <span class="op">**</span> <span class="op">(</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">-</span> <span class="num">20</span><span class="op">)</span> <span class="op">/</span> <span class="num">10</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1235" href="#t1235">1235</a></span><span class="t">        <span class="key">elif</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1236" href="#t1236">1236</a></span><span class="t">            <span class="nam">temperature_dependence_factor</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">/</span> <span class="num">5</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1237" href="#t1237">1237</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1238" href="#t1238">1238</a></span><span class="t">            <span class="nam">temperature_dependence_factor</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1239" href="#t1239">1239</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">temperature_dependence_factor</span> <span class="op">=</span> <span class="nam">temperature_dependence_factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1240" href="#t1240">1240</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1241" href="#t1241">1241</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1242" href="#t1242">1242</a></span><span class="t">    <span class="key">def</span> <span class="nam">calc_soil_moisture_dependence_factor</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1243" href="#t1243">1243</a></span><span class="t">        <span class="str">"""Process function that calculates the soil moisture dependence factor for </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1244" href="#t1244">1244</a></span><span class="t"><span class="str">        the nutrient pool (which impacts soil pool transformations)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1245" href="#t1245">1245</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1246" href="#t1246">1246</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1247" href="#t1247">1247</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1248" href="#t1248">1248</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1249" href="#t1249">1249</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1250" href="#t1250">1250</a></span><span class="t">        <span class="com">#Parameters/equations from HYPE documentation</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1251" href="#t1251">1251</a></span><span class="t">        <span class="nam">current_soil_moisture</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_smc</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1252" href="#t1252">1252</a></span><span class="t">        <span class="key">if</span> <span class="nam">current_soil_moisture</span>  <span class="op">>=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1253" href="#t1253">1253</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">soil_moisture_dependence_factor</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">satact</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1254" href="#t1254">1254</a></span><span class="t">        <span class="key">elif</span> <span class="nam">current_soil_moisture</span> <span class="op">&lt;=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">wilting_point</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1255" href="#t1255">1255</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">soil_moisture_dependence_factor</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1256" href="#t1256">1256</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1257" href="#t1257">1257</a></span><span class="t">            <span class="nam">fc_diff</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span> <span class="op">-</span> <span class="nam">current_soil_moisture</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1258" href="#t1258">1258</a></span><span class="t">            <span class="nam">fc_comp</span> <span class="op">=</span> <span class="op">(</span><span class="nam">fc_diff</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">thetaupp</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span><span class="op">)</span><span class="op">)</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">thetapow</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1259" href="#t1259">1259</a></span><span class="t">            <span class="nam">fc_comp</span> <span class="op">=</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">satact</span><span class="op">)</span> <span class="op">*</span> <span class="nam">fc_comp</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">satact</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1260" href="#t1260">1260</a></span><span class="t">            <span class="nam">wp_diff</span> <span class="op">=</span> <span class="nam">current_soil_moisture</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">wilting_point</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1261" href="#t1261">1261</a></span><span class="t">            <span class="nam">wp_comp</span> <span class="op">=</span> <span class="op">(</span><span class="nam">wp_diff</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">thetalow</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span><span class="op">)</span><span class="op">)</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">thetapow</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1262" href="#t1262">1262</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">soil_moisture_dependence_factor</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="num">1</span><span class="op">,</span> <span class="nam">wp_comp</span><span class="op">,</span> <span class="nam">fc_comp</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1263" href="#t1263">1263</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1264" href="#t1264">1264</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1265" href="#t1265">1265</a></span><span class="t">    <span class="key">def</span> <span class="nam">calc_crop_uptake</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1266" href="#t1266">1266</a></span><span class="t">        <span class="str">"""Process function that calculates how much nutrient crops uptake and updates </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1267" href="#t1267">1267</a></span><span class="t"><span class="str">        nutrient pool and surface tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1268" href="#t1268">1268</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1269" href="#t1269">1269</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1270" href="#t1270">1270</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1271" href="#t1271">1271</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1272" href="#t1272">1272</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1273" href="#t1273">1273</a></span><span class="t">        <span class="com">#Parameters/equations from HYPE documentation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1274" href="#t1274">1274</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1275" href="#t1275">1275</a></span><span class="t">        <span class="com">#Initialise</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1276" href="#t1276">1276</a></span><span class="t">        <span class="nam">N_common_uptake</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1277" href="#t1277">1277</a></span><span class="t">        <span class="nam">P_common_uptake</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1278" href="#t1278">1278</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1279" href="#t1279">1279</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1280" href="#t1280">1280</a></span><span class="t">            <span class="com">#If there are crops</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1281" href="#t1281">1281</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1282" href="#t1282">1282</a></span><span class="t">            <span class="nam">days_after_sow</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1283" href="#t1283">1283</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1284" href="#t1284">1284</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">autumn_sow</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1285" href="#t1285">1285</a></span><span class="t">                <span class="nam">temp_func</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="nam">min</span><span class="op">(</span><span class="num">1</span><span class="op">,</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'temperature'</span><span class="op">]</span> <span class="op">-</span> <span class="num">5</span><span class="op">)</span> <span class="op">/</span> <span class="num">20</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1286" href="#t1286">1286</a></span><span class="t">                <span class="nam">days_after_sow</span> <span class="op">-=</span> <span class="num">25</span> <span class="com">#Not sure why this is (but it's in HYPE)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1287" href="#t1287">1287</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1288" href="#t1288">1288</a></span><span class="t">                <span class="nam">temp_func</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1289" href="#t1289">1289</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1290" href="#t1290">1290</a></span><span class="t">            <span class="com">#Calculate uptake</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1291" href="#t1291">1291</a></span><span class="t">            <span class="nam">uptake_par</span> <span class="op">=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">uptake1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">uptake2</span><span class="op">)</span> <span class="op">*</span> <span class="nam">exp</span><span class="op">(</span><span class="op">-</span><span class="nam">self</span><span class="op">.</span><span class="nam">uptake3</span> <span class="op">*</span> <span class="nam">days_after_sow</span><span class="op">)</span> <span class="op">*</span> <span class="nam">temp_func</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1292" href="#t1292">1292</a></span><span class="t">            <span class="key">if</span> <span class="op">(</span><span class="nam">uptake_par</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">uptake2</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span> <span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1293" href="#t1293">1293</a></span><span class="t">                <span class="nam">N_common_uptake</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">uptake1</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">uptake2</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">uptake3</span> <span class="op">*</span> <span class="nam">uptake_par</span> <span class="op">/</span> <span class="op">(</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">uptake2</span> <span class="op">+</span> <span class="nam">uptake_par</span><span class="op">)</span> <span class="op">**</span> <span class="num">2</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1294" href="#t1294">1294</a></span><span class="t">            <span class="nam">N_common_uptake</span> <span class="op">*=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">G_M2_TO_KG_M2</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1295" href="#t1295">1295</a></span><span class="t">            <span class="nam">P_common_uptake</span> <span class="op">=</span> <span class="nam">N_common_uptake</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">uptake_PNratio</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1296" href="#t1296">1296</a></span><span class="t">            <span class="nam">uptake</span> <span class="op">=</span> <span class="op">{</span><span class="str">'P'</span> <span class="op">:</span> <span class="nam">P_common_uptake</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1297" href="#t1297">1297</a></span><span class="t">                      <span class="str">'N'</span> <span class="op">:</span> <span class="nam">N_common_uptake</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1298" href="#t1298">1298</a></span><span class="t">            <span class="nam">crop_uptake</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">extract</span><span class="op">(</span><span class="nam">uptake</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1299" href="#t1299">1299</a></span><span class="t">            <span class="nam">out_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1300" href="#t1300">1300</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1301" href="#t1301">1301</a></span><span class="t">            <span class="com"># Assuming plants eat N and P as nitrate and phosphate</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1302" href="#t1302">1302</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">crop_uptake</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1303" href="#t1303">1303</a></span><span class="t">            <span class="nam">out_</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">crop_uptake</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1304" href="#t1304">1304</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1305" href="#t1305">1305</a></span><span class="t">            <span class="nam">out2_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_pollutants</span><span class="op">(</span><span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1306" href="#t1306">1306</a></span><span class="t">            <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">compare_vqip</span><span class="op">(</span><span class="nam">out_</span><span class="op">,</span> <span class="nam">out2_</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1307" href="#t1307">1307</a></span><span class="t">                <span class="nam">print</span><span class="op">(</span><span class="str">'nutrient pool not tracking soil tank'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1308" href="#t1308">1308</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1309" href="#t1309">1309</a></span><span class="t">            <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1310" href="#t1310">1310</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1311" href="#t1311">1311</a></span><span class="t">            <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1312" href="#t1312">1312</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1313" href="#t1313">1313</a></span><span class="t">    <span class="key">def</span> <span class="nam">erosion</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1314" href="#t1314">1314</a></span><span class="t">        <span class="str">"""Outflow function that erodes adsorbed/humus phosphorus and sediment and sends onwards to percolation/surface runoff/subsurface runoff</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1315" href="#t1315">1315</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1316" href="#t1316">1316</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1317" href="#t1317">1317</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1318" href="#t1318">1318</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1319" href="#t1319">1319</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1320" href="#t1320">1320</a></span><span class="t">        <span class="com">#Parameters/equations from HYPE documentation (which explains why my documentation is a bit ambiguous - because theirs is too)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1321" href="#t1321">1321</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1322" href="#t1322">1322</a></span><span class="t">        <span class="com">#Convert precipitation to MM since all the equations assume that</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1323" href="#t1323">1323</a></span><span class="t">        <span class="nam">precipitation_depth</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_data_input</span><span class="op">(</span><span class="str">'precipitation'</span><span class="op">)</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M_TO_MM</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1324" href="#t1324">1324</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1325" href="#t1325">1325</a></span><span class="t">        <span class="com">#Calculate how much rain is mobilising erosion</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1326" href="#t1326">1326</a></span><span class="t">        <span class="key">if</span> <span class="nam">precipitation_depth</span> <span class="op">></span> <span class="num">5</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1327" href="#t1327">1327</a></span><span class="t">            <span class="nam">rainfall_energy</span> <span class="op">=</span> <span class="num">8.95</span> <span class="op">+</span> <span class="num">8.44</span> <span class="op">*</span> <span class="nam">log10</span><span class="op">(</span><span class="nam">precipitation_depth</span> <span class="op">*</span> <span class="op">(</span><span class="num">0.257</span> <span class="op">+</span> <span class="nam">sin</span><span class="op">(</span><span class="num">2</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">PI</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">t</span><span class="op">.</span><span class="nam">dayofyear</span> <span class="op">-</span> <span class="num">70</span><span class="op">)</span> <span class="op">/</span> <span class="num">365</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="num">0.09</span><span class="op">)</span> <span class="op">*</span> <span class="num">2</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1328" href="#t1328">1328</a></span><span class="t">            <span class="nam">rainfall_energy</span> <span class="op">*=</span> <span class="nam">precipitation_depth</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1329" href="#t1329">1329</a></span><span class="t">            <span class="nam">mobilised_rain</span> <span class="op">=</span> <span class="nam">rainfall_energy</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">crop_cover</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">erodibility</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1330" href="#t1330">1330</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1331" href="#t1331">1331</a></span><span class="t">            <span class="nam">mobilised_rain</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1332" href="#t1332">1332</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1333" href="#t1333">1333</a></span><span class="t">        <span class="com">#Calculate if any infiltration is mobilising erosion</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1334" href="#t1334">1334</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1335" href="#t1335">1335</a></span><span class="t">            <span class="nam">mobilised_flow</span> <span class="op">=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M_TO_MM</span> <span class="op">*</span> <span class="num">365</span><span class="op">)</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sreroexp</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1336" href="#t1336">1336</a></span><span class="t">            <span class="nam">mobilised_flow</span> <span class="op">*=</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ground_cover</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span><span class="op">/</span><span class="op">(</span><span class="num">0.5</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">cohesion</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="nam">sin</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">slope</span> <span class="op">/</span> <span class="num">100</span><span class="op">)</span> <span class="op">/</span> <span class="num">365</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1337" href="#t1337">1337</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1338" href="#t1338">1338</a></span><span class="t">            <span class="nam">mobilised_flow</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1339" href="#t1339">1339</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1340" href="#t1340">1340</a></span><span class="t">        <span class="com">#Sum flows (not sure why surface runoff isn't included)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1341" href="#t1341">1341</a></span><span class="t">        <span class="com">#TODO I'm pretty sure it should be included here</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1342" href="#t1342">1342</a></span><span class="t">        <span class="nam">total_flows</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="com">#m3/dt + self.tank_recharge['volume'] (guess not needed)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1343" href="#t1343">1343</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1344" href="#t1344">1344</a></span><span class="t">        <span class="com">#Convert to MM/M2</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1345" href="#t1345">1345</a></span><span class="t">        <span class="nam">erodingflow</span> <span class="op">=</span> <span class="nam">total_flows</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M_TO_MM</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1346" href="#t1346">1346</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1347" href="#t1347">1347</a></span><span class="t">        <span class="com">#Calculate eroded sediment</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1348" href="#t1348">1348</a></span><span class="t">        <span class="nam">transportfactor</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="num">1</span><span class="op">,</span> <span class="op">(</span><span class="nam">erodingflow</span> <span class="op">/</span> <span class="num">4</span><span class="op">)</span> <span class="op">**</span> <span class="num">1.3</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1349" href="#t1349">1349</a></span><span class="t">        <span class="nam">erodedsed</span> <span class="op">=</span> <span class="num">1000</span> <span class="op">*</span> <span class="op">(</span><span class="nam">mobilised_flow</span> <span class="op">+</span>  <span class="nam">mobilised_rain</span><span class="op">)</span> <span class="op">*</span> <span class="nam">transportfactor</span> <span class="com"># [kg/km2]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1350" href="#t1350">1350</a></span><span class="t">        <span class="com">#TODO not sure what conversion this HYPE 1000 is referring to</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1351" href="#t1351">1351</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1352" href="#t1352">1352</a></span><span class="t">        <span class="com"># soil erosion with adsorbed inorganic phosphorus and humus phosphorus (erodedP as P in eroded sediments and effect of enrichment)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1353" href="#t1353">1353</a></span><span class="t">        <span class="key">if</span> <span class="nam">erodingflow</span> <span class="op">></span> <span class="num">4</span> <span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1354" href="#t1354">1354</a></span><span class="t">            <span class="nam">enrichment</span> <span class="op">=</span> <span class="num">1.5</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1355" href="#t1355">1355</a></span><span class="t">        <span class="key">elif</span> <span class="nam">erodingflow</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1356" href="#t1356">1356</a></span><span class="t">            <span class="nam">enrichment</span> <span class="op">=</span> <span class="num">4</span> <span class="op">-</span> <span class="op">(</span><span class="num">4</span> <span class="op">-</span> <span class="num">1.5</span><span class="op">)</span> <span class="op">*</span> <span class="nam">erodingflow</span> <span class="op">/</span> <span class="num">4</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1357" href="#t1357">1357</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1358" href="#t1358">1358</a></span><span class="t">            <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1359" href="#t1359">1359</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1360" href="#t1360">1360</a></span><span class="t">        <span class="com">#Get erodable phosphorus</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1361" href="#t1361">1361</a></span><span class="t">        <span class="nam">erodableP</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_erodable_P</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">KG_M2_TO_KG_KM2</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1362" href="#t1362">1362</a></span><span class="t">        <span class="nam">erodedP</span> <span class="op">=</span> <span class="nam">erodedsed</span> <span class="op">*</span> <span class="op">(</span><span class="nam">erodableP</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M_TO_KM</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">bulk_density</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">KG_M3_TO_KG_KM3</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="nam">enrichment</span> <span class="com"># [kg/km2]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1363" href="#t1363">1363</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1364" href="#t1364">1364</a></span><span class="t">        <span class="com">#Convert to kg</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1365" href="#t1365">1365</a></span><span class="t">        <span class="nam">erodedP</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M2_TO_KM2</span><span class="op">)</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1366" href="#t1366">1366</a></span><span class="t">        <span class="nam">erodedsed</span> <span class="op">*=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M2_TO_KM2</span><span class="op">)</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1367" href="#t1367">1367</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1368" href="#t1368">1368</a></span><span class="t">        <span class="com">#Allocate to different flows</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1369" href="#t1369">1369</a></span><span class="t">        <span class="nam">surface_erodedP</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">srfilt</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_flows</span> <span class="op">*</span> <span class="nam">erodedP</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1370" href="#t1370">1370</a></span><span class="t">        <span class="nam">surface_erodedsed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">srfilt</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_flows</span> <span class="op">*</span> <span class="nam">erodedsed</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1371" href="#t1371">1371</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1372" href="#t1372">1372</a></span><span class="t">        <span class="nam">subsurface_erodedP</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">macrofilt</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_flows</span> <span class="op">*</span> <span class="nam">erodedP</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1373" href="#t1373">1373</a></span><span class="t">        <span class="nam">subsurface_erodedsed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">macrofilt</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_flows</span> <span class="op">*</span> <span class="nam">erodedsed</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1374" href="#t1374">1374</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1375" href="#t1375">1375</a></span><span class="t">        <span class="nam">percolation_erodedP</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">macrofilt</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_flows</span> <span class="op">*</span> <span class="nam">erodedP</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1376" href="#t1376">1376</a></span><span class="t">        <span class="nam">percolation_erodedsed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">macrofilt</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_flows</span> <span class="op">*</span> <span class="nam">erodedsed</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1377" href="#t1377">1377</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1378" href="#t1378">1378</a></span><span class="t">        <span class="com">#Track mass balance</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1379" href="#t1379">1379</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1380" href="#t1380">1380</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1381" href="#t1381">1381</a></span><span class="t">        <span class="com">#Total eroded phosphorus </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1382" href="#t1382">1382</a></span><span class="t">        <span class="nam">eff_erodedP</span> <span class="op">=</span> <span class="nam">percolation_erodedP</span> <span class="op">+</span> <span class="nam">surface_erodedP</span> <span class="op">+</span> <span class="nam">subsurface_erodedP</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1383" href="#t1383">1383</a></span><span class="t">        <span class="key">if</span> <span class="nam">eff_erodedP</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1384" href="#t1384">1384</a></span><span class="t">            <span class="com">#Update nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1385" href="#t1385">1385</a></span><span class="t">            <span class="nam">org_removed</span><span class="op">,</span> <span class="nam">inorg_removed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">erode_P</span><span class="op">(</span><span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1386" href="#t1386">1386</a></span><span class="t">            <span class="nam">total_removed</span> <span class="op">=</span> <span class="nam">inorg_removed</span> <span class="op">+</span> <span class="nam">org_removed</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1387" href="#t1387">1387</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1388" href="#t1388">1388</a></span><span class="t">            <span class="key">if</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">total_removed</span> <span class="op">-</span> <span class="nam">eff_erodedP</span><span class="op">)</span> <span class="op">></span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1389" href="#t1389">1389</a></span><span class="t">                <span class="nam">print</span><span class="op">(</span><span class="str">'weird nutrients'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1390" href="#t1390">1390</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1391" href="#t1391">1391</a></span><span class="t">            <span class="com">#scale flows to split between inorganic and organic eroded P  </span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1392" href="#t1392">1392</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">surface_erodedP</span> <span class="op">*</span> <span class="nam">org_removed</span> <span class="op">/</span> <span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1393" href="#t1393">1393</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">subsurface_erodedP</span> <span class="op">*</span> <span class="nam">org_removed</span> <span class="op">/</span> <span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1394" href="#t1394">1394</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">percolation_erodedP</span> <span class="op">*</span> <span class="nam">org_removed</span> <span class="op">/</span> <span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1395" href="#t1395">1395</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1396" href="#t1396">1396</a></span><span class="t">            <span class="com">#TODO Leon reckons this is conceptually dodgy.. but i'm not sure where else adsorbed inorganic phosphorus should go</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1397" href="#t1397">1397</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">surface_erodedP</span> <span class="op">*</span> <span class="nam">inorg_removed</span> <span class="op">/</span> <span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1398" href="#t1398">1398</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">subsurface_erodedP</span> <span class="op">*</span> <span class="nam">inorg_removed</span> <span class="op">/</span> <span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1399" href="#t1399">1399</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">+=</span> <span class="op">(</span><span class="nam">percolation_erodedP</span> <span class="op">*</span> <span class="nam">inorg_removed</span> <span class="op">/</span> <span class="nam">eff_erodedP</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1400" href="#t1400">1400</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1401" href="#t1401">1401</a></span><span class="t">            <span class="com">#Entering the model (no need to uptake surface tank because both adsorbed inorganic pool and humus pool are solids and so no tracked in the soil water tank)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1402" href="#t1402">1402</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">inorg_removed</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1403" href="#t1403">1403</a></span><span class="t">            <span class="nam">in_</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">org_removed</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1404" href="#t1404">1404</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1405" href="#t1405">1405</a></span><span class="t">            <span class="nam">inorg_to_org_P</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1406" href="#t1406">1406</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1407" href="#t1407">1407</a></span><span class="t">        <span class="com">#Track sediment as solids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1408" href="#t1408">1408</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">infiltration_excess</span><span class="op">[</span><span class="str">'solids'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">surface_erodedsed</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1409" href="#t1409">1409</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">subsurface_flow</span><span class="op">[</span><span class="str">'solids'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">subsurface_erodedsed</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1410" href="#t1410">1410</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">percolation</span><span class="op">[</span><span class="str">'solids'</span><span class="op">]</span> <span class="op">+=</span> <span class="nam">percolation_erodedsed</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1411" href="#t1411">1411</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1412" href="#t1412">1412</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1413" href="#t1413">1413</a></span><span class="t">        <span class="nam">in_</span><span class="op">[</span><span class="str">'solids'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">surface_erodedsed</span> <span class="op">+</span> <span class="nam">subsurface_erodedsed</span> <span class="op">+</span> <span class="nam">percolation_erodedsed</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1414" href="#t1414">1414</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1415" href="#t1415">1415</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1416" href="#t1416">1416</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1417" href="#t1417">1417</a></span><span class="t">    <span class="key">def</span> <span class="nam">denitrification</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1418" href="#t1418">1418</a></span><span class="t">        <span class="str">"""Outflow function that performs denitirication processes, updating nutrient pool and soil tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1419" href="#t1419">1419</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1420" href="#t1420">1420</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1421" href="#t1421">1421</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1422" href="#t1422">1422</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1423" href="#t1423">1423</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1424" href="#t1424">1424</a></span><span class="t">        <span class="com">#Parameters/equations from HYPE documentation </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1425" href="#t1425">1425</a></span><span class="t">        <span class="com">#TODO could more of this be moved to NutrientPool</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1426" href="#t1426">1426</a></span><span class="t">        <span class="com">#Calculate soil moisture dependence of denitrification</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1427" href="#t1427">1427</a></span><span class="t">        <span class="nam">soil_moisture_content</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_smc</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1428" href="#t1428">1428</a></span><span class="t">        <span class="key">if</span> <span class="nam">soil_moisture_content</span> <span class="op">></span> <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1429" href="#t1429">1429</a></span><span class="t">            <span class="nam">denitrifying_soil_moisture_dependence</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1430" href="#t1430">1430</a></span><span class="t">        <span class="key">elif</span> <span class="nam">soil_moisture_content</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span> <span class="op">></span> <span class="nam">self</span><span class="op">.</span><span class="nam">limpar</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1431" href="#t1431">1431</a></span><span class="t">            <span class="nam">denitrifying_soil_moisture_dependence</span> <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="nam">soil_moisture_content</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">field_capacity</span><span class="op">)</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">limpar</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">limpar</span><span class="op">)</span><span class="op">)</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">exppar</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1432" href="#t1432">1432</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1433" href="#t1433">1433</a></span><span class="t">            <span class="nam">denitrifying_soil_moisture_dependence</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1434" href="#t1434">1434</a></span><span class="t">            <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1435" href="#t1435">1435</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1436" href="#t1436">1436</a></span><span class="t">        <span class="com">#Get dissolved inorg nitrogen as a concentration and calculate factor</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1437" href="#t1437">1437</a></span><span class="t">        <span class="nam">din_conc</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="com"># [kg/m3]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1438" href="#t1438">1438</a></span><span class="t">        <span class="nam">din_conc</span> <span class="op">*=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">KG_M3_TO_MG_L</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1439" href="#t1439">1439</a></span><span class="t">        <span class="nam">half_saturation_concentration_dependence_factor</span> <span class="op">=</span> <span class="nam">din_conc</span> <span class="op">/</span> <span class="op">(</span><span class="nam">din_conc</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">hsatINs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1440" href="#t1440">1440</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1441" href="#t1441">1441</a></span><span class="t">        <span class="com">#Calculate and extract dentrified nitrogen</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1442" href="#t1442">1442</a></span><span class="t">        <span class="nam">denitrified_N</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">*</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1443" href="#t1443">1443</a></span><span class="t">                            <span class="nam">half_saturation_concentration_dependence_factor</span> <span class="op">*</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1444" href="#t1444">1444</a></span><span class="t">                                <span class="nam">denitrifying_soil_moisture_dependence</span> <span class="op">*</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1445" href="#t1445">1445</a></span><span class="t">                                    <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">temperature_dependence_factor</span> <span class="op">*</span><span class="xx">\</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1446" href="#t1446">1446</a></span><span class="t">                                        <span class="nam">self</span><span class="op">.</span><span class="nam">denpar</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1447" href="#t1447">1447</a></span><span class="t">        <span class="nam">denitrified_request</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1448" href="#t1448">1448</a></span><span class="t">        <span class="nam">denitrified_request</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">denitrified_N</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1449" href="#t1449">1449</a></span><span class="t">        <span class="nam">denitrified_N</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">extract</span><span class="op">(</span><span class="nam">denitrified_request</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1450" href="#t1450">1450</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1451" href="#t1451">1451</a></span><span class="t">        <span class="com">#Leon reckons this should leave the model (though I think technically some small amount goes to nitrite)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1452" href="#t1452">1452</a></span><span class="t">        <span class="nam">out_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1453" href="#t1453">1453</a></span><span class="t">        <span class="nam">out_</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">denitrified_N</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1454" href="#t1454">1454</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1455" href="#t1455">1455</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1456" href="#t1456">1456</a></span><span class="t">        <span class="nam">out2_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_pollutants</span><span class="op">(</span><span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1457" href="#t1457">1457</a></span><span class="t">        <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">compare_vqip</span><span class="op">(</span><span class="nam">out_</span><span class="op">,</span> <span class="nam">out2_</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1458" href="#t1458">1458</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">'nutrient pool not tracking soil tank'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1459" href="#t1459">1459</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1460" href="#t1460">1460</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1461" href="#t1461">1461</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1462" href="#t1462">1462</a></span><span class="t">    <span class="key">def</span> <span class="nam">adsorption</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1463" href="#t1463">1463</a></span><span class="t">        <span class="str">"""Outflow function that calculates phosphorus adsorption/desorptions and </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1464" href="#t1464">1464</a></span><span class="t"><span class="str">        updates soil tank and nutrient pools</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1465" href="#t1465">1465</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1466" href="#t1466">1466</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1467" href="#t1467">1467</a></span><span class="t"><span class="str">            (tuple): A tuple containing a VQIP amount for model inputs and outputs </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1468" href="#t1468">1468</a></span><span class="t"><span class="str">                for mass balance checking. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1469" href="#t1469">1469</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1470" href="#t1470">1470</a></span><span class="t">        <span class="com">#Parameters/equations from HYPE documentation </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1471" href="#t1471">1471</a></span><span class="t">        <span class="com">#TODO could this be moved to the nutrient pool?</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1472" href="#t1472">1472</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1473" href="#t1473">1473</a></span><span class="t">        <span class="com">#Initialise mass balance checking</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1474" href="#t1474">1474</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1475" href="#t1475">1475</a></span><span class="t">        <span class="nam">out_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1476" href="#t1476">1476</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1477" href="#t1477">1477</a></span><span class="t">        <span class="com">#Get total phosphorus in pool available for adsorption/desorption</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1478" href="#t1478">1478</a></span><span class="t">        <span class="nam">limit</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adosorption_nr_limit</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1479" href="#t1479">1479</a></span><span class="t">        <span class="nam">ad_de_P_pool</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">adsorbed_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1480" href="#t1480">1480</a></span><span class="t">        <span class="nam">ad_de_P_pool</span> <span class="op">/=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M2_TO_KM2</span><span class="op">)</span> <span class="com"># [kg/km2]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1481" href="#t1481">1481</a></span><span class="t">        <span class="key">if</span> <span class="nam">ad_de_P_pool</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1482" href="#t1482">1482</a></span><span class="t">            <span class="key">return</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1483" href="#t1483">1483</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1484" href="#t1484">1484</a></span><span class="t">        <span class="com">#Calculate coefficient and concentration of adsorbed phosphorus</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1485" href="#t1485">1485</a></span><span class="t">        <span class="nam">soil_moisture_content</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_smc</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M_TO_MM</span> <span class="com"># [mm] (not sure why HYPE has this in mm but whatever)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1486" href="#t1486">1486</a></span><span class="t">        <span class="nam">conc_sol</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">adsorbed_inorganic_pool</span><span class="op">.</span><span class="nam">storage</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">KG_TO_MG</span> <span class="op">/</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">bulk_density</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">area</span><span class="op">)</span><span class="com"># [mg P/kg soil]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1487" href="#t1487">1487</a></span><span class="t">        <span class="nam">coeff</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">kfr</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">bulk_density</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M_TO_MM</span> <span class="com"># [mm]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1488" href="#t1488">1488</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1489" href="#t1489">1489</a></span><span class="t">        <span class="com"># calculate equilibrium concentration</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1490" href="#t1490">1490</a></span><span class="t">        <span class="key">if</span> <span class="nam">conc_sol</span> <span class="op">&lt;=</span> <span class="num">0</span> <span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1491" href="#t1491">1491</a></span><span class="t">            <span class="com">#Not sure how this would happen</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1492" href="#t1492">1492</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">'Warning: soil partP &lt;=0. Freundlich will give error, take shortcut.'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1493" href="#t1493">1493</a></span><span class="t">            <span class="nam">xn_1</span> <span class="op">=</span> <span class="nam">ad_de_P_pool</span> <span class="op">/</span> <span class="op">(</span><span class="nam">soil_moisture_content</span> <span class="op">+</span> <span class="nam">coeff</span><span class="op">)</span> <span class="com"># [mg/l]</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1494" href="#t1494">1494</a></span><span class="t">            <span class="nam">ad_P_equi_conc</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">kfr</span> <span class="op">*</span> <span class="nam">xn_1</span>   <span class="com"># [mg/ kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1495" href="#t1495">1495</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1496" href="#t1496">1496</a></span><span class="t">            <span class="com"># Newton-Raphson method</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1497" href="#t1497">1497</a></span><span class="t">            <span class="nam">x0</span> <span class="op">=</span> <span class="nam">exp</span><span class="op">(</span><span class="op">(</span><span class="nam">log</span><span class="op">(</span><span class="nam">conc_sol</span><span class="op">)</span> <span class="op">-</span> <span class="nam">log</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">kfr</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span><span class="op">)</span> <span class="com"># initial guess of equilibrium liquid concentration</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1498" href="#t1498">1498</a></span><span class="t">            <span class="nam">fxn</span> <span class="op">=</span> <span class="nam">x0</span> <span class="op">*</span> <span class="nam">soil_moisture_content</span> <span class="op">+</span> <span class="nam">coeff</span> <span class="op">*</span> <span class="op">(</span><span class="nam">x0</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span><span class="op">)</span> <span class="op">-</span> <span class="nam">ad_de_P_pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1499" href="#t1499">1499</a></span><span class="t">            <span class="nam">xn</span> <span class="op">=</span> <span class="nam">x0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1500" href="#t1500">1500</a></span><span class="t">            <span class="nam">xn_1</span> <span class="op">=</span> <span class="nam">xn</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1501" href="#t1501">1501</a></span><span class="t">            <span class="nam">j</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1502" href="#t1502">1502</a></span><span class="t">            <span class="key">while</span> <span class="op">(</span><span class="nam">abs</span><span class="op">(</span><span class="nam">fxn</span><span class="op">)</span> <span class="op">></span> <span class="nam">limit</span> <span class="key">and</span> <span class="nam">j</span> <span class="op">&lt;</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adsorption_nr_maxiter</span><span class="op">)</span> <span class="op">:</span> <span class="com"># iteration to calculate equilibrium concentations</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1503" href="#t1503">1503</a></span><span class="t">                <span class="nam">fxn</span> <span class="op">=</span> <span class="nam">xn</span> <span class="op">*</span> <span class="nam">soil_moisture_content</span> <span class="op">+</span> <span class="nam">coeff</span> <span class="op">*</span> <span class="op">(</span><span class="nam">xn</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span><span class="op">)</span> <span class="op">-</span> <span class="nam">ad_de_P_pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1504" href="#t1504">1504</a></span><span class="t">                <span class="nam">fprimxn</span> <span class="op">=</span> <span class="nam">soil_moisture_content</span> <span class="op">+</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span> <span class="op">*</span> <span class="nam">coeff</span> <span class="op">*</span> <span class="op">(</span><span class="nam">xn</span> <span class="op">**</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span> <span class="op">-</span> <span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1505" href="#t1505">1505</a></span><span class="t">                <span class="nam">dx</span> <span class="op">=</span> <span class="nam">fxn</span> <span class="op">/</span> <span class="nam">fprimxn</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1506" href="#t1506">1506</a></span><span class="t">                <span class="key">if</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">dx</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="num">0.000001</span> <span class="op">*</span> <span class="nam">xn</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1507" href="#t1507">1507</a></span><span class="t">                    <span class="com">#From HYPE... not sure what it means</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1508" href="#t1508">1508</a></span><span class="t">                    <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1509" href="#t1509">1509</a></span><span class="t">                <span class="nam">xn_1</span> <span class="op">=</span> <span class="nam">xn</span> <span class="op">-</span> <span class="nam">dx</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1510" href="#t1510">1510</a></span><span class="t">                <span class="key">if</span> <span class="nam">xn_1</span> <span class="op">&lt;=</span> <span class="num">0</span> <span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1511" href="#t1511">1511</a></span><span class="t">                    <span class="nam">xn_1</span> <span class="op">=</span> <span class="num">1e-10</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1512" href="#t1512">1512</a></span><span class="t">                <span class="nam">xn</span> <span class="op">=</span> <span class="nam">xn_1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1513" href="#t1513">1513</a></span><span class="t">                <span class="nam">j</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1514" href="#t1514">1514</a></span><span class="t">            <span class="nam">ad_P_equi_conc</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">kfr</span> <span class="op">*</span> <span class="op">(</span><span class="nam">xn_1</span> <span class="op">**</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nfr</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1515" href="#t1515">1515</a></span><span class="t">            <span class="com">#print(ad_P_equi_conc, conc_sol)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1516" href="#t1516">1516</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1517" href="#t1517">1517</a></span><span class="t">        <span class="com"># Calculate new pool and concentration, depends on the equilibrium concentration</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1518" href="#t1518">1518</a></span><span class="t">        <span class="key">if</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">ad_P_equi_conc</span> <span class="op">-</span> <span class="nam">conc_sol</span><span class="op">)</span> <span class="op">></span> <span class="num">1e-6</span> <span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1519" href="#t1519">1519</a></span><span class="t">            <span class="nam">request</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1520" href="#t1520">1520</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1521" href="#t1521">1521</a></span><span class="t">            <span class="com">#TODO not sure about this if statement, surely it would be triggered every time</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1522" href="#t1522">1522</a></span><span class="t">            <span class="nam">adsdes</span> <span class="op">=</span> <span class="op">(</span><span class="nam">ad_P_equi_conc</span> <span class="op">-</span> <span class="nam">conc_sol</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">exp</span><span class="op">(</span><span class="op">-</span><span class="nam">self</span><span class="op">.</span><span class="nam">kadsdes</span><span class="op">)</span><span class="op">)</span> <span class="com"># kinetic adsorption/desorption</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1523" href="#t1523">1523</a></span><span class="t">            <span class="nam">request</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">adsdes</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">bulk_density</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">rooting_depth</span> <span class="op">*</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">area</span> <span class="op">*</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">M2_TO_KM2</span><span class="op">)</span> <span class="com"># [kg]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1524" href="#t1524">1524</a></span><span class="t">            <span class="key">if</span> <span class="nam">request</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1525" href="#t1525">1525</a></span><span class="t">                <span class="com">#Adsorption</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1526" href="#t1526">1526</a></span><span class="t">                <span class="nam">adsorbed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">extract</span><span class="op">(</span><span class="nam">request</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1527" href="#t1527">1527</a></span><span class="t">                <span class="key">if</span> <span class="op">(</span><span class="nam">adsorbed</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">request</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1528" href="#t1528">1528</a></span><span class="t">                    <span class="nam">print</span><span class="op">(</span><span class="str">'Warning: freundlich flow adjusted, was larger than pool'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1529" href="#t1529">1529</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">adsorbed_inorganic_pool</span><span class="op">.</span><span class="nam">receive</span><span class="op">(</span><span class="nam">adsorbed</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1530" href="#t1530">1530</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1531" href="#t1531">1531</a></span><span class="t">                <span class="com">#Dissolved leaving the soil water tank and becoming solid</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1532" href="#t1532">1532</a></span><span class="t">                <span class="nam">out_</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">adsorbed</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1533" href="#t1533">1533</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1534" href="#t1534">1534</a></span><span class="t">                <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1535" href="#t1535">1535</a></span><span class="t">                <span class="nam">out2_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">pull_pollutants</span><span class="op">(</span><span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1536" href="#t1536">1536</a></span><span class="t">                <span class="key">if</span> <span class="key">not</span> <span class="nam">self</span><span class="op">.</span><span class="nam">compare_vqip</span><span class="op">(</span><span class="nam">out_</span><span class="op">,</span> <span class="nam">out2_</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1537" href="#t1537">1537</a></span><span class="t">                    <span class="nam">print</span><span class="op">(</span><span class="str">'nutrient pool not tracking soil tank'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1538" href="#t1538">1538</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1539" href="#t1539">1539</a></span><span class="t">                <span class="com">#Desorption</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1540" href="#t1540">1540</a></span><span class="t">                <span class="nam">request</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="nam">request</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1541" href="#t1541">1541</a></span><span class="t">                <span class="nam">desorbed</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">adsorbed_inorganic_pool</span><span class="op">.</span><span class="nam">extract</span><span class="op">(</span><span class="nam">request</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1542" href="#t1542">1542</a></span><span class="t">                <span class="key">if</span> <span class="op">(</span><span class="nam">desorbed</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">request</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1543" href="#t1543">1543</a></span><span class="t">                    <span class="nam">print</span><span class="op">(</span><span class="str">'Warning: freundlich flow adjusted, was larger than pool'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1544" href="#t1544">1544</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">dissolved_inorganic_pool</span><span class="op">.</span><span class="nam">receive</span><span class="op">(</span><span class="nam">desorbed</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1545" href="#t1545">1545</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1546" href="#t1546">1546</a></span><span class="t">                <span class="com">#Solid phosphorus becoming inorganic P in the soil water tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1547" href="#t1547">1547</a></span><span class="t">                <span class="nam">in_</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">desorbed</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1548" href="#t1548">1548</a></span><span class="t">                <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1549" href="#t1549">1549</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1550" href="#t1550">1550</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">in_</span><span class="op">,</span> <span class="nam">out_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1551" href="#t1551">1551</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1552" href="#t1552">1552</a></span><span class="t">    <span class="key">def</span> <span class="nam">dry_deposition_to_tank</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1553" href="#t1553">1553</a></span><span class="t">        <span class="str">"""Allocate dry deposition to surface tank, updating nutrient pool accordingly.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1554" href="#t1554">1554</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1555" href="#t1555">1555</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1556" href="#t1556">1556</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of dry deposition to send to tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1557" href="#t1557">1557</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1558" href="#t1558">1558</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1559" href="#t1559">1559</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of dry deposition that entered the tank (used </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1560" href="#t1560">1560</a></span><span class="t"><span class="str">                for mass balance checking)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1561" href="#t1561">1561</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1562" href="#t1562">1562</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1563" href="#t1563">1563</a></span><span class="t">        <span class="com">#Convert to nutrients</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1564" href="#t1564">1564</a></span><span class="t">        <span class="nam">deposition</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1565" href="#t1565">1565</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1566" href="#t1566">1566</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1567" href="#t1567">1567</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1568" href="#t1568">1568</a></span><span class="t">        <span class="com">#Update nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1569" href="#t1569">1569</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_dry_deposition</span><span class="op">(</span><span class="nam">deposition</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1570" href="#t1570">1570</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adjust_vqip_to_liquid</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">deposition</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1571" href="#t1571">1571</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1572" href="#t1572">1572</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1573" href="#t1573">1573</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1574" href="#t1574">1574</a></span><span class="t">        <span class="key">return</span> <span class="nam">vqip</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1575" href="#t1575">1575</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1576" href="#t1576">1576</a></span><span class="t">    <span class="key">def</span> <span class="nam">wet_deposition_to_tank</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1577" href="#t1577">1577</a></span><span class="t">        <span class="str">"""Allocate wet deposition to surface tank, updating nutrient pool accordingly.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1578" href="#t1578">1578</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1579" href="#t1579">1579</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1580" href="#t1580">1580</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of dry deposition to send to tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1581" href="#t1581">1581</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1582" href="#t1582">1582</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1583" href="#t1583">1583</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of dry deposition that entered the tank (used </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1584" href="#t1584">1584</a></span><span class="t"><span class="str">                for mass balance checking)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1585" href="#t1585">1585</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1586" href="#t1586">1586</a></span><span class="t">        <span class="com">#Convert to nutrients</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1587" href="#t1587">1587</a></span><span class="t">        <span class="nam">deposition</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">get_empty_nutrient</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1588" href="#t1588">1588</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'N'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1589" href="#t1589">1589</a></span><span class="t">        <span class="nam">deposition</span><span class="op">[</span><span class="str">'P'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vqip</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1590" href="#t1590">1590</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1591" href="#t1591">1591</a></span><span class="t">        <span class="com">#Update nutrient pool</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1592" href="#t1592">1592</a></span><span class="t">        <span class="nam">in_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_wet_deposition</span><span class="op">(</span><span class="nam">deposition</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1593" href="#t1593">1593</a></span><span class="t">        <span class="nam">vqip</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">adjust_vqip_to_liquid</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">deposition</span><span class="op">,</span> <span class="nam">in_</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1594" href="#t1594">1594</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1595" href="#t1595">1595</a></span><span class="t">        <span class="com">#Update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1596" href="#t1596">1596</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1597" href="#t1597">1597</a></span><span class="t">        <span class="key">return</span> <span class="nam">vqip</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1598" href="#t1598">1598</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1599" href="#t1599">1599</a></span><span class="t"><span class="key">class</span> <span class="nam">IrrigationSurface</span><span class="op">(</span><span class="nam">GrowingSurface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1600" href="#t1600">1600</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">irrigation_coefficient</span> <span class="op">=</span> <span class="num">0.1</span><span class="op">,</span><span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1601" href="#t1601">1601</a></span><span class="t">        <span class="str">"""A subclass of GrowingSurface that can calculate water demand for the crops </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1602" href="#t1602">1602</a></span><span class="t"><span class="str">        that is not met by precipitation and use the parent node to acquire water. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1603" href="#t1603">1603</a></span><span class="t"><span class="str">        When the surface is created by the parent node, the irrigate function below is </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1604" href="#t1604">1604</a></span><span class="t"><span class="str">        assigned. </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1605" href="#t1605">1605</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1606" href="#t1606">1606</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1607" href="#t1607">1607</a></span><span class="t"><span class="str">            irrigation_coefficient (float, optional): proportion area irrigated * </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1608" href="#t1608">1608</a></span><span class="t"><span class="str">                proportion of demand met. Defaults to 0.1.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1609" href="#t1609">1609</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1610" href="#t1610">1610</a></span><span class="t">        <span class="com">#Assign param</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1611" href="#t1611">1611</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">irrigation_coefficient</span> <span class="op">=</span> <span class="nam">irrigation_coefficient</span> <span class="com">#proportion area irrigated * proportion of demand met</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1612" href="#t1612">1612</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1613" href="#t1613">1613</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1614" href="#t1614">1614</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1615" href="#t1615">1615</a></span><span class="t">    <span class="key">def</span> <span class="nam">irrigate</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1616" href="#t1616">1616</a></span><span class="t">        <span class="str">"""Calculate water demand for crops and call parent node to acquire water, </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1617" href="#t1617">1617</a></span><span class="t"><span class="str">        updating surface tank and nutrient pools</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1618" href="#t1618">1618</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1619" href="#t1619">1619</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">days_after_sow</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1620" href="#t1620">1620</a></span><span class="t">            <span class="com">#Irrigation is just difference between evaporation and precipitation amount</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1621" href="#t1621">1621</a></span><span class="t">            <span class="nam">irrigation_demand</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span><span class="op">,</span> <span class="num">0</span><span class="op">)</span> <span class="op">*</span> <span class="nam">self</span><span class="op">.</span><span class="nam">irrigation_coefficient</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1622" href="#t1622">1622</a></span><span class="t">            <span class="key">if</span> <span class="nam">irrigation_demand</span> <span class="op">></span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1623" href="#t1623">1623</a></span><span class="t">                <span class="nam">root_zone_depletion</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_cmd</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1624" href="#t1624">1624</a></span><span class="t">                <span class="key">if</span> <span class="nam">root_zone_depletion</span> <span class="op">&lt;=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1625" href="#t1625">1625</a></span><span class="t">                    <span class="com">#TODO this isn't in FAO... but seems sensible</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1626" href="#t1626">1626</a></span><span class="t">                    <span class="nam">irrigation_demand</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1627" href="#t1627">1627</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1628" href="#t1628">1628</a></span><span class="t">                <span class="com">#Pull water using parent node</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1629" href="#t1629">1629</a></span><span class="t">                <span class="nam">supplied</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">pull_distributed</span><span class="op">(</span><span class="op">{</span><span class="str">'volume'</span> <span class="op">:</span> <span class="nam">irrigation_demand</span><span class="op">}</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1630" href="#t1630">1630</a></span><span class="t">                                                         <span class="nam">of_type</span> <span class="op">=</span> <span class="op">[</span><span class="str">'River'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1631" href="#t1631">1631</a></span><span class="t">                                                                    <span class="str">'Node'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1632" href="#t1632">1632</a></span><span class="t">                                                                    <span class="str">'Groundwater'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1633" href="#t1633">1633</a></span><span class="t">                                                                    <span class="str">'Reservoir'</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1634" href="#t1634">1634</a></span><span class="t">                                                                    <span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1635" href="#t1635">1635</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1636" href="#t1636">1636</a></span><span class="t">                <span class="com">#update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1637" href="#t1637">1637</a></span><span class="t">                <span class="nam">_</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">supplied</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1638" href="#t1638">1638</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1639" href="#t1639">1639</a></span><span class="t">                <span class="com">#update nutrient pools</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1640" href="#t1640">1640</a></span><span class="t">                <span class="nam">organic</span> <span class="op">=</span> <span class="op">{</span><span class="str">'N'</span> <span class="op">:</span> <span class="nam">supplied</span><span class="op">[</span><span class="str">'org-nitrogen'</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1641" href="#t1641">1641</a></span><span class="t">                           <span class="str">'P'</span> <span class="op">:</span> <span class="nam">supplied</span><span class="op">[</span><span class="str">'org-phosphorus'</span><span class="op">]</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1642" href="#t1642">1642</a></span><span class="t">                <span class="nam">inorganic</span> <span class="op">=</span> <span class="op">{</span><span class="str">'N'</span> <span class="op">:</span> <span class="nam">supplied</span><span class="op">[</span><span class="str">'ammonia'</span><span class="op">]</span> <span class="op">+</span> <span class="nam">supplied</span><span class="op">[</span><span class="str">'nitrate'</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1643" href="#t1643">1643</a></span><span class="t">                             <span class="str">'P'</span> <span class="op">:</span> <span class="nam">supplied</span><span class="op">[</span><span class="str">'phosphate'</span><span class="op">]</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1644" href="#t1644">1644</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_organic_irrigation</span><span class="op">(</span><span class="nam">organic</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1645" href="#t1645">1645</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">nutrient_pool</span><span class="op">.</span><span class="nam">allocate_inorganic_irrigation</span><span class="op">(</span><span class="nam">inorganic</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1646" href="#t1646">1646</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1647" href="#t1647">1647</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1648" href="#t1648">1648</a></span><span class="t"><span class="key">class</span> <span class="nam">GardenSurface</span><span class="op">(</span><span class="nam">GrowingSurface</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1649" href="#t1649">1649</a></span><span class="t">    <span class="com">#TODO - probably a simplier version of this is useful, building just on pervioussurface</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1650" href="#t1650">1650</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1651" href="#t1651">1651</a></span><span class="t">        <span class="str">"""A specific surface for gardens that treats the garden as a grass crop, but </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1652" href="#t1652">1652</a></span><span class="t"><span class="str">        that can calculate/receive irrigation through functions that are assigned by </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1653" href="#t1653">1653</a></span><span class="t"><span class="str">        the parent land node's handlers, which in turn are expected to be triggered by </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1654" href="#t1654">1654</a></span><span class="t"><span class="str">        a query from an attached Demand node.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1655" href="#t1655">1655</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1656" href="#t1656">1656</a></span><span class="t">        <span class="nam">super</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">__init__</span><span class="op">(</span><span class="op">**</span><span class="nam">kwargs</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1657" href="#t1657">1657</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1658" href="#t1658">1658</a></span><span class="t">    <span class="key">def</span> <span class="nam">calculate_irrigation_demand</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">ignore_vqip</span> <span class="op">=</span> <span class="key">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1659" href="#t1659">1659</a></span><span class="t">        <span class="str">"""A check function (assigned by parent to push check from demand nodes) that </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1660" href="#t1660">1660</a></span><span class="t"><span class="str">        calculations irrigation demand (i.e., difference between evaporation and </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1661" href="#t1661">1661</a></span><span class="t"><span class="str">        preciptiation)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1662" href="#t1662">1662</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1663" href="#t1663">1663</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1664" href="#t1664">1664</a></span><span class="t"><span class="str">            ignore_vqip (any, optional): Conventional push checks send an optional </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1665" href="#t1665">1665</a></span><span class="t"><span class="str">                VQIP amount, however the intention with this check is to get the </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1666" href="#t1666">1666</a></span><span class="t"><span class="str">                irrigation demand</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1667" href="#t1667">1667</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1668" href="#t1668">1668</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1669" href="#t1669">1669</a></span><span class="t"><span class="str">            reply (dict): A VQIP amount of irrigation demand (note only 'volume' key </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1670" href="#t1670">1670</a></span><span class="t"><span class="str">                is used)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1671" href="#t1671">1671</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1672" href="#t1672">1672</a></span><span class="t">        <span class="com">#Calculate irrigation demand</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1673" href="#t1673">1673</a></span><span class="t">        <span class="nam">irrigation_demand</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">evaporation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">precipitation</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span><span class="op">,</span> <span class="num">0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1674" href="#t1674">1674</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1675" href="#t1675">1675</a></span><span class="t">        <span class="nam">root_zone_depletion</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_cmd</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1676" href="#t1676">1676</a></span><span class="t">        <span class="key">if</span> <span class="nam">root_zone_depletion</span> <span class="op">&lt;=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">FLOAT_ACCURACY</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1677" href="#t1677">1677</a></span><span class="t">            <span class="com">#TODO this isn't in FAO... but seems sensible</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1678" href="#t1678">1678</a></span><span class="t">            <span class="nam">irrigation_demand</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1679" href="#t1679">1679</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1680" href="#t1680">1680</a></span><span class="t">        <span class="com">#Reply as VQIP</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1681" href="#t1681">1681</a></span><span class="t">        <span class="nam">reply</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">empty_vqip</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1682" href="#t1682">1682</a></span><span class="t">        <span class="nam">reply</span><span class="op">[</span><span class="str">'volume'</span><span class="op">]</span> <span class="op">=</span> <span class="nam">irrigation_demand</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1683" href="#t1683">1683</a></span><span class="t">        <span class="key">return</span> <span class="nam">reply</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1684" href="#t1684">1684</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1685" href="#t1685">1685</a></span><span class="t">    <span class="key">def</span> <span class="nam">receive_irrigation_demand</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vqip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1686" href="#t1686">1686</a></span><span class="t">        <span class="str">"""A set function (assigned by parent to push set from demand nodes) that assigns irrigation water supply to the surface tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1687" href="#t1687">1687</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1688" href="#t1688">1688</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1689" href="#t1689">1689</a></span><span class="t"><span class="str">            vqip (dict): A VQIP amount of irrigation to receive</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1690" href="#t1690">1690</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1691" href="#t1691">1691</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1692" href="#t1692">1692</a></span><span class="t"><span class="str">            (dict): A VQIP amount of irrigation that was not received (should always </span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1693" href="#t1693">1693</a></span><span class="t"><span class="str">                be empty)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1694" href="#t1694">1694</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1695" href="#t1695">1695</a></span><span class="t">        <span class="com">#update tank</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1696" href="#t1696">1696</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">push_storage</span><span class="op">(</span><span class="nam">vqip</span><span class="op">,</span> <span class="nam">force</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1697" href="#t1697">1697</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
</main>
<footer>
    <div class="content">
        <p>
            <a id="prevFileLink" class="nav" href="d_158041b68a4502ad_distribution_py.html">&#xab; prev</a> &nbsp; &nbsp;
            <a id="indexLink" class="nav" href="covindex.html">&Hat; index</a> &nbsp; &nbsp;
            <a id="nextFileLink" class="nav" href="d_158041b68a4502ad_nodes_py.html">&#xbb; next</a>
            &nbsp; &nbsp; &nbsp;
            <a class="nav" href="https://coverage.readthedocs.io">coverage.py v6.5.0</a>,
            created at 2022-11-05 12:05 +0000
        </p>
    </div>
</footer>
</body>
</html>
